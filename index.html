<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAN KARTU - Aplikasi Kartu Pelajar</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 1200px;
        }
        .card-container {
            perspective: 1000px;
            width: 320px;
            height: 200px;
        }
        .student-card {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 12px;
        }
        .student-card-front, .student-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            padding: 16px;
            background-size: cover;
            background-position: center;
        }
        .student-card-back {
            transform: rotateY(180deg);
        }
        .card-container:hover .student-card {
            transform: rotateY(180deg);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* QR Code verification page styling */
        .verification-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f3f4f6;
            z-index: 200;
            padding: 2rem;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .verification-page.active {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <!-- Third-party library scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Main Content -->
    <main id="app-container" class="flex-grow p-4 md:p-8">

        <!-- Login Page -->
        <div id="login-page" class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
                <img id="login-logo" src="https://iili.io/FsvxSNj.png" alt="Logo Sekolah" class="w-24 h-24 mx-auto mb-4 rounded-full object-cover">
                <h1 class="text-3xl font-bold mb-2">VAN KARTU</h1>
                <p class="text-gray-600 mb-6">Login Kartu Pelajar</p>
                <form id="login-form">
                    <div class="mb-4 text-left">
                        <label for="username" class="block text-sm font-medium text-gray-700">NISN / Username</label>
                        <input type="text" id="username" name="username" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="mb-6 text-left">
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="password" name="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 font-bold">Masuk</button>
                    <div id="login-error" class="text-red-500 text-sm mt-4 hidden">Username atau password salah.</div>
                </form>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="container mx-auto p-4 hidden">
            <header class="flex flex-col md:flex-row items-center justify-between bg-white rounded-xl shadow-md p-4 mb-6">
                <div class="flex items-center mb-4 md:mb-0">
                    <img id="header-logo" src="https://placehold.co/60x60/e5e7eb/555?text=LOGO" alt="Logo Sekolah" class="w-12 h-12 rounded-full object-cover mr-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Dashboard Admin</h2>
                        <p id="header-school-name" class="text-gray-500">Nama Sekolah</p>
                    </div>
                </div>
                <button id="logout-button" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md shadow-md hover:bg-gray-300 transition-colors">Logout</button>
            </header>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

                <!-- Sidebar Navigation -->
                <div class="lg:col-span-1 bg-white rounded-xl shadow-md p-6">
                    <nav>
                        <ul class="space-y-2">
                            <li><button class="nav-item w-full text-left py-2 px-4 rounded-lg hover:bg-indigo-50 transition-colors text-indigo-600 font-semibold" data-target="student-data">Manajemen Siswa</button></li>
                            <li><button class="nav-item w-full text-left py-2 px-4 rounded-lg hover:bg-indigo-50 transition-colors" data-target="upload-photos">Upload Foto</button></li>
                            <li><button class="nav-item w-full text-left py-2 px-4 rounded-lg hover:bg-indigo-50 transition-colors" data-target="upload-excel">Upload Excel</button></li>
                            <li><button class="nav-item w-full text-left py-2 px-4 rounded-lg hover:bg-indigo-50 transition-colors" data-target="card-settings">Pengaturan Kartu</button></li>
                            <li><button class="nav-item w-full text-left py-2 px-4 rounded-lg hover:bg-indigo-50 transition-colors" data-target="print-cards">Cetak Kartu</button></li>
                            <li><button class="nav-item w-full text-left py-2 px-4 rounded-lg hover:bg-indigo-50 transition-colors" data-target="settings">Pengaturan Sekolah</button></li>
                        </ul>
                    </nav>
                </div>

                <!-- Main Content Panel -->
                <div class="lg:col-span-3 bg-white rounded-xl shadow-md p-6">
                    <!-- Student Data Management Section -->
                    <div id="student-data" class="tab-content active">
                        <h3 class="text-xl font-bold mb-4">Manajemen Data Siswa</h3>
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" id="search-student" placeholder="Cari NISN atau Nama" class="px-3 py-2 border border-gray-300 rounded-md w-full max-w-sm">
                            <button id="add-student-button" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-bold ml-4">Tambah Siswa</button>
                        </div>
                        <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIS</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Lengkap</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Kelamin</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Lahir</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="student-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Student rows will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Upload Excel Section -->
                    <div id="upload-excel" class="tab-content hidden">
                        <h3 class="text-xl font-bold mb-4">Upload Data Siswa (Excel)</h3>
                        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-4">
                            <p class="text-sm text-gray-600 mb-4">Pastikan file Excel Anda menggunakan format yang benar. Anda bisa mengunduh template di bawah ini.</p>
                            <a href="#" id="download-template" class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-md hover:bg-indigo-100 transition-colors font-semibold">Unduh Template Excel</a>
                        </div>
                        <div class="flex flex-col items-start space-y-4">
                            <label for="excel-file" class="block text-sm font-medium text-gray-700">Pilih File Excel (.xlsx)</label>
                            <input type="file" id="excel-file" accept=".xlsx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                            <button id="upload-excel-button" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-bold">Unggah dan Simpan</button>
                        </div>
                    </div>

                    <!-- Upload Photos Section -->
                    <div id="upload-photos" class="tab-content hidden">
                        <h3 class="text-xl font-bold mb-4">Upload Foto Siswa (Massal)</h3>
                        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-4">
                            <p class="text-sm text-gray-600 mb-4">Unggah banyak foto sekaligus. Pastikan nama file foto sama dengan NISN siswa (misal: 0012345678.jpg).</p>
                        </div>
                        <div class="flex flex-col items-start space-y-4">
                            <label for="photo-files" class="block text-sm font-medium text-gray-700">Pilih File Foto (JPG/PNG)</label>
                            <input type="file" id="photo-files" multiple accept="image/jpeg, image/png" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                            <button id="upload-photos-button" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-bold">Unggah dan Proses</button>
                        </div>
                        <div id="photo-upload-status" class="mt-4 text-sm text-gray-600"></div>
                    </div>
                    
                    <!-- Card Settings Section -->
                    <div id="card-settings" class="tab-content hidden">
                        <h3 class="text-xl font-bold mb-4">Pengaturan Desain Kartu</h3>
                        <form id="card-design-form" class="space-y-4">
                            <div>
                                <label for="card-background" class="block text-sm font-medium text-gray-700">Unggah Desain Latar Belakang Kartu</label>
                                <input type="file" id="card-background" accept="image/jpeg, image/png" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                            </div>
                            <button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-bold">Simpan Desain Kartu</button>
                        </form>
                    </div>

                    <!-- Print Cards Section -->
                    <div id="print-cards" class="tab-content hidden">
                        <h3 class="text-xl font-bold mb-4">Cetak Kartu Pelajar</h3>
                        <p class="text-sm text-gray-600 mb-4">Pilih siswa yang akan dicetak kartunya.</p>
                        <div class="overflow-x-auto rounded-lg border border-gray-200 max-h-96">
                             <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            <input type="checkbox" id="select-all-students">
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Lengkap</th>
                                    </tr>
                                </thead>
                                <tbody id="print-student-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Student rows will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex space-x-2">
                             <button id="print-selected-pdf" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-bold">Cetak ke PDF</button>
                             <button id="print-selected-image" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 font-bold">Simpan sebagai Gambar</button>
                        </div>
                        <div id="print-area" class="mt-8 hidden"></div>
                    </div>
                    
                    <!-- Settings Section -->
                    <div id="settings" class="tab-content hidden">
                        <h3 class="text-xl font-bold mb-4">Pengaturan Sekolah</h3>
                        <form id="school-settings-form" class="space-y-4">
                            <div>
                                <label for="school-name" class="block text-sm font-medium text-gray-700">Nama Sekolah</label>
                                <input type="text" id="school-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="school-address" class="block text-sm font-medium text-gray-700">Alamat</label>
                                <input type="text" id="school-address" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="school-phone" class="block text-sm font-medium text-gray-700">Telepon</label>
                                <input type="text" id="school-phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="school-logo" class="block text-sm font-medium text-gray-700">Logo Sekolah</label>
                                <input type="file" id="school-logo" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                            </div>
                            <div>
                                <label for="principal-name" class="block text-sm font-medium text-gray-700">Nama Kepala Sekolah</label>
                                <input type="text" id="principal-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="principal-signature" class="block text-sm font-medium text-gray-700">Tanda Tangan Kepala Sekolah</label>
                                <input type="file" id="principal-signature" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                            </div>
                            <button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-bold">Simpan Pengaturan</button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
        
        <!-- Student Dashboard -->
        <div id="student-dashboard" class="container mx-auto p-4 hidden">
            <header class="flex items-center justify-between bg-white rounded-xl shadow-md p-4 mb-6">
                <div class="flex items-center">
                    <img id="student-header-logo" src="https://placehold.co/60x60/e5e7eb/555?text=LOGO" alt="Logo Sekolah" class="w-12 h-12 rounded-full object-cover mr-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Dashboard Siswa</h2>
                        <p id="student-header-school-name" class="text-gray-500">Nama Sekolah</p>
                    </div>
                </div>
                <button id="student-logout-button" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md shadow-md hover:bg-gray-300 transition-colors">Logout</button>
            </header>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Student Profile Section -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-bold mb-4">Profil Saya</h3>
                    <div class="flex flex-col items-center mb-6">
                        <img id="student-profile-photo" src="https://placehold.co/120x150/e5e7eb/555?text=FOTO" alt="Foto Siswa" class="w-32 h-40 object-cover rounded-md mb-4 border border-gray-200">
                        <form id="student-photo-form">
                            <label for="student-new-photo" class="block text-sm font-medium text-gray-700 mb-2">Unggah Foto Baru</label>
                            <input type="file" id="student-new-photo" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                            <button type="submit" class="mt-2 bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-bold w-full">Simpan Foto</button>
                        </form>
                    </div>
                    <div class="space-y-2 text-gray-700">
                        <div class="border-b pb-2">
                            <span class="font-semibold block text-sm text-gray-500">Nama Lengkap</span>
                            <span id="student-profile-name" class="text-lg"></span>
                        </div>
                        <div class="border-b pb-2">
                            <span class="font-semibold block text-sm text-gray-500">NISN</span>
                            <span id="student-profile-nisn" class="text-lg"></span>
                        </div>
                        <div class="border-b pb-2">
                            <span class="font-semibold block text-sm text-gray-500">NIS</span>
                            <span id="student-profile-nis" class="text-lg"></span>
                        </div>
                        <div class="border-b pb-2">
                            <span class="font-semibold block text-sm text-gray-500">Jenis Kelamin</span>
                            <span id="student-profile-gender" class="text-lg"></span>
                        </div>
                        <div class="border-b pb-2">
                            <span class="font-semibold block text-sm text-gray-500">Tanggal Lahir</span>
                            <span id="student-profile-dob" class="text-lg"></span>
                        </div>
                    </div>
                    <div class="mt-6">
                         <button id="show-edit-profile-modal-button" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 font-bold w-full">Ajukan Perbaikan Data</button>
                    </div>
                </div>

                <!-- Student Card & Download Section -->
                <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center">
                    <h3 class="text-xl font-bold mb-4">Kartu Pelajar Saya</h3>
                    <div class="card-container mb-6">
                        <div id="student-card-preview" class="student-card">
                            <div id="student-card-front" class="student-card-front bg-gray-100 p-4 border border-gray-200">
                                <!-- Card content will be dynamically generated here -->
                            </div>
                            <div id="student-card-back" class="student-card-back bg-gray-100 p-4 border border-gray-200">
                                <div class="flex justify-center items-center h-full">
                                    <div id="qr-code-student" class="p-2 bg-white rounded-lg"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                         <button id="download-card-png" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-bold">Unduh PNG</button>
                         <button id="download-card-pdf" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-bold">Unduh PDF</button>
                    </div>
                </div>
            </div>
        </div>
        
    </main>

    <!-- Modals -->

    <!-- Student Edit Modal -->
    <div id="edit-student-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h4 class="text-xl font-bold mb-4" id="modal-title">Tambah Siswa</h4>
            <form id="edit-student-form" class="space-y-4">
                <input type="hidden" id="modal-student-index">
                <div>
                    <label for="modal-nisn" class="block text-sm font-medium text-gray-700">NISN</label>
                    <input type="text" id="modal-nisn" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="modal-nis" class="block text-sm font-medium text-gray-700">NIS</label>
                    <input type="text" id="modal-nis" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="modal-nama" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                    <input type="text" id="modal-nama" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="modal-jk" class="block text-sm font-medium text-gray-700">Jenis Kelamin</label>
                    <select id="modal-jk" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="Laki-laki">Laki-laki</option>
                        <option value="Perempuan">Perempuan</option>
                    </select>
                </div>
                <div>
                    <label for="modal-dob" class="block text-sm font-medium text-gray-700">Tanggal Lahir</label>
                    <input type="date" id="modal-dob" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-bold w-full">Simpan</button>
            </form>
        </div>
    </div>
    
    <!-- Student Profile Edit Modal (for students) -->
    <div id="student-edit-profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h4 class="text-xl font-bold mb-4">Ajukan Perbaikan Data</h4>
            <form id="student-edit-profile-form" class="space-y-4">
                <div>
                    <label for="student-modal-nama" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                    <input type="text" id="student-modal-nama" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="student-modal-nis" class="block text-sm font-medium text-gray-700">NIS</label>
                    <input type="text" id="student-modal-nis" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="student-modal-jk" class="block text-sm font-medium text-gray-700">Jenis Kelamin</label>
                    <select id="student-modal-jk" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="Laki-laki">Laki-laki</option>
                        <option value="Perempuan">Perempuan</option>
                    </select>
                </div>
                <div>
                    <label for="student-modal-dob" class="block text-sm font-medium text-gray-700">Tanggal Lahir</label>
                    <input type="date" id="student-modal-dob" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-bold w-full">Simpan Perubahan</button>
            </form>
        </div>
    </div>

    <!-- QR Code Verification Page -->
    <div id="verification-page" class="verification-page">
        <button id="close-verification" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-3xl font-bold">&times;</button>
        <div class="bg-white p-8 rounded-xl shadow-lg text-center max-w-md w-full">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Verifikasi Kartu Pelajar</h2>
            <img id="qr-logo" src="https://placehold.co/100x100/e5e7eb/555?text=LOGO" alt="Logo Sekolah" class="w-16 h-16 mx-auto mb-4 rounded-full object-cover">
            <div id="verification-content" class="text-left space-y-2">
                <p class="text-gray-600"><span class="font-semibold block text-sm text-gray-500">Nama:</span> <span id="ver-name" class="text-lg font-medium"></span></p>
                <p class="text-gray-600"><span class="font-semibold block text-sm text-gray-500">NISN:</span> <span id="ver-nisn" class="text-lg font-medium"></span></p>
                <p class="text-gray-600"><span class="font-semibold block text-sm text-gray-500">Status:</span> <span id="ver-status" class="text-green-600 text-lg font-medium">Aktif</span></p>
            </div>
        </div>
    </div>


    <script>
        // Data inisialisasi default
        const defaultStudents = [
            { nisn: "0012345678", nis: "12345", nama_lengkap: "Budi Santoso", jenis_kelamin: "Laki-laki", tanggal_lahir: "2008-05-15", photo: "" },
            { nisn: "0098765432", nis: "54321", nama_lengkap: "Siti Aminah", jenis_kelamin: "Perempuan", tanggal_lahir: "2007-09-21", photo: "" },
        ];

        const defaultSettings = {
            schoolName: "SMK Tunas Bangsa",
            schoolAddress: "Jl. Raya Cirebon No. 123",
            schoolPhone: "0231-123456",
            schoolLogo: null,
            principalName: "Drs. Budi Sutomo, M.Pd.",
            principalSignature: null,
            cardBackground: null,
        };

        // DOM elements
        const appContainer = document.getElementById('app-container');
        const loginPage = document.getElementById('login-page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginLogo = document.getElementById('login-logo');
        
        const adminDashboard = document.getElementById('admin-dashboard');
        const studentDashboard = document.getElementById('student-dashboard');
        const logoutButton = document.getElementById('logout-button');
        const studentLogoutButton = document.getElementById('student-logout-button');
        const headerSchoolName = document.getElementById('header-school-name');
        const headerLogo = document.getElementById('header-logo');
        
        const tabContents = document.querySelectorAll('.tab-content');
        const navItems = document.querySelectorAll('.nav-item');
        
        const studentTableBody = document.getElementById('student-table-body');
        const searchStudentInput = document.getElementById('search-student');
        const addStudentButton = document.getElementById('add-student-button');
        const editStudentModal = document.getElementById('edit-student-modal');
        const editStudentForm = document.getElementById('edit-student-form');
        const modalCloseButtons = document.querySelectorAll('.close-button');
        
        const excelFile = document.getElementById('excel-file');
        const uploadExcelButton = document.getElementById('upload-excel-button');
        const downloadTemplate = document.getElementById('download-template');
        
        const photoFiles = document.getElementById('photo-files');
        const uploadPhotosButton = document.getElementById('upload-photos-button');
        const photoUploadStatus = document.getElementById('photo-upload-status');
        
        const schoolSettingsForm = document.getElementById('school-settings-form');
        const schoolNameInput = document.getElementById('school-name');
        const schoolAddressInput = document.getElementById('school-address');
        const schoolPhoneInput = document.getElementById('school-phone');
        const schoolLogoInput = document.getElementById('school-logo');
        const principalNameInput = document.getElementById('principal-name');
        const principalSignatureInput = document.getElementById('principal-signature');
        
        const cardDesignForm = document.getElementById('card-design-form');
        const cardBackgroundInput = document.getElementById('card-background');
        
        const printStudentTableBody = document.getElementById('print-student-table-body');
        const selectAllStudents = document.getElementById('select-all-students');
        const printSelectedPdfButton = document.getElementById('print-selected-pdf');
        const printSelectedImageButton = document.getElementById('print-selected-image');
        const printArea = document.getElementById('print-area');
        
        const studentProfilePhoto = document.getElementById('student-profile-photo');
        const studentProfileName = document.getElementById('student-profile-name');
        const studentProfileNisn = document.getElementById('student-profile-nisn');
        const studentProfileNis = document.getElementById('student-profile-nis');
        const studentProfileGender = document.getElementById('student-profile-gender');
        const studentProfileDob = document.getElementById('student-profile-dob');
        const studentPhotoForm = document.getElementById('student-photo-form');
        const studentCardPreview = document.getElementById('student-card-preview');
        const studentEditProfileModal = document.getElementById('student-edit-profile-modal');
        const showEditProfileModalButton = document.getElementById('show-edit-profile-modal-button');
        const studentEditProfileForm = document.getElementById('student-edit-profile-form');
        const downloadCardPngButton = document.getElementById('download-card-png');
        const downloadCardPdfButton = document.getElementById('download-card-pdf');
        
        const verificationPage = document.getElementById('verification-page');
        const closeVerificationButton = document.getElementById('close-verification');
        const verName = document.getElementById('ver-name');
        const verNisn = document.getElementById('ver-nisn');
        const qrLogo = document.getElementById('qr-logo');
        
        let students = JSON.parse(localStorage.getItem('students')) || defaultStudents;
        let settings = JSON.parse(localStorage.getItem('settings')) || defaultSettings;
        let loggedInUser = null;

        // --- Inisialisasi Aplikasi ---
        function initializeApp() {
            updateSettings();
            renderStudentTable();
            renderPrintTable();
            showPage('login');
        }

        // --- Fungsi Helper ---
        function saveData() {
            localStorage.setItem('students', JSON.stringify(students));
            localStorage.setItem('settings', JSON.stringify(settings));
        }
        
        function showPage(page) {
            loginPage.classList.add('hidden');
            adminDashboard.classList.add('hidden');
            studentDashboard.classList.add('hidden');
            verificationPage.classList.remove('active');
            
            if (page === 'login') {
                loginPage.classList.remove('hidden');
            } else if (page === 'admin') {
                adminDashboard.classList.remove('hidden');
                switchAdminTab('student-data'); // Default tab
            } else if (page === 'student') {
                studentDashboard.classList.remove('hidden');
                updateStudentDashboard(loggedInUser);
            } else if (page === 'verification') {
                 verificationPage.classList.add('active');
            }
        }
        
        function updateSettings() {
            // Update UI with current settings
            headerSchoolName.textContent = settings.schoolName;
            studentHeaderSchoolName.textContent = settings.schoolName;
            schoolNameInput.value = settings.schoolName;
            schoolAddressInput.value = settings.schoolAddress;
            schoolPhoneInput.value = settings.schoolPhone;
            principalNameInput.value = settings.principalName;
            
            if (settings.schoolLogo) {
                loginLogo.src = settings.schoolLogo;
                headerLogo.src = settings.schoolLogo;
                studentHeaderLogo.src = settings.schoolLogo;
                qrLogo.src = settings.schoolLogo;
            } else {
                loginLogo.src = "https://placehold.co/150x150/e5e7eb/555?text=LOGO";
                headerLogo.src = "https://placehold.co/60x60/e5e7eb/555?text=LOGO";
                studentHeaderLogo.src = "https://placehold.co/60x60/e5e7eb/555?text=LOGO";
                qrLogo.src = "https://placehold.co/100x100/e5e7eb/555?text=LOGO";
            }
        }

        function switchAdminTab(targetId) {
            tabContents.forEach(tab => tab.classList.add('hidden'));
            navItems.forEach(item => item.classList.remove('text-indigo-600', 'font-semibold'));
            
            document.getElementById(targetId).classList.remove('hidden');
            document.querySelector(`[data-target="${targetId}"]`).classList.add('text-indigo-600', 'font-semibold');
        }

        // --- Login & Logout ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = e.target.username.value;
            const password = e.target.password.value;
            
            if (username === "Van64" && password === "Van1909") {
                loggedInUser = { role: 'admin' };
                showPage('admin');
            } else {
                const student = students.find(s => s.nisn === username && s.nisn === password);
                if (student) {
                    loggedInUser = { role: 'student', data: student };
                    showPage('student');
                } else {
                    loginError.classList.remove('hidden');
                }
            }
        });

        logoutButton.addEventListener('click', () => {
            loggedInUser = null;
            showPage('login');
        });

        studentLogoutButton.addEventListener('click', () => {
            loggedInUser = null;
            showPage('login');
        });

        // --- Admin Dashboard: Manajemen Siswa ---
        function renderStudentTable(filteredStudents = students) {
            studentTableBody.innerHTML = '';
            if (filteredStudents.length === 0) {
                studentTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Tidak ada data siswa.</td></tr>';
                return;
            }
            
            filteredStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${student.nisn}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${student.nis}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${student.nama_lengkap}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${student.jenis_kelamin}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${student.tanggal_lahir}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="edit-student text-indigo-600 hover:text-indigo-900 mr-2" data-nisn="${student.nisn}">Edit</button>
                        <button class="delete-student text-red-600 hover:text-red-900" data-nisn="${student.nisn}">Hapus</button>
                    </td>
                `;
                studentTableBody.appendChild(row);
            });
        }
        
        searchStudentInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = students.filter(student =>
                student.nisn.includes(searchTerm) || student.nama_lengkap.toLowerCase().includes(searchTerm)
            );
            renderStudentTable(filtered);
        });

        addStudentButton.addEventListener('click', () => {
            document.getElementById('modal-title').textContent = "Tambah Siswa";
            editStudentForm.reset();
            editStudentModal.style.display = 'flex';
        });

        editStudentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const index = document.getElementById('modal-student-index').value;
            const newStudent = {
                nisn: document.getElementById('modal-nisn').value,
                nis: document.getElementById('modal-nis').value,
                nama_lengkap: document.getElementById('modal-nama').value,
                jenis_kelamin: document.getElementById('modal-jk').value,
                tanggal_lahir: document.getElementById('modal-dob').value,
                photo: students[index] ? students[index].photo : '', // Preserve existing photo
            };
            
            if (index) {
                // Edit
                students[index] = newStudent;
            } else {
                // Add
                students.push(newStudent);
            }
            
            saveData();
            renderStudentTable();
            renderPrintTable();
            editStudentModal.style.display = 'none';
        });

        studentTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-student')) {
                const nisn = e.target.dataset.nisn;
                const studentToEdit = students.find(s => s.nisn === nisn);
                const index = students.findIndex(s => s.nisn === nisn);
                if (studentToEdit) {
                    document.getElementById('modal-title').textContent = "Edit Siswa";
                    document.getElementById('modal-student-index').value = index;
                    document.getElementById('modal-nisn').value = studentToEdit.nisn;
                    document.getElementById('modal-nis').value = studentToEdit.nis;
                    document.getElementById('modal-nama').value = studentToEdit.nama_lengkap;
                    document.getElementById('modal-jk').value = studentToEdit.jenis_kelamin;
                    document.getElementById('modal-dob').value = studentToEdit.tanggal_lahir;
                    editStudentModal.style.display = 'flex';
                }
            } else if (e.target.classList.contains('delete-student')) {
                const nisn = e.target.dataset.nisn;
                if (confirm(`Apakah Anda yakin ingin menghapus data siswa dengan NISN ${nisn}?`)) {
                    students = students.filter(s => s.nisn !== nisn);
                    saveData();
                    renderStudentTable();
                    renderPrintTable();
                }
            }
        });

        // --- Admin Dashboard: Upload Excel ---
        downloadTemplate.addEventListener('click', () => {
            const ws = XLSX.utils.json_to_sheet([{ NAMA_LENGKAP: '', NISN: '', NIS: '', JENIS_KELAMIN: '', TANGGAL_LAHIR: '' }]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Siswa");
            XLSX.writeFile(wb, "template_data_siswa.xlsx");
        });

        uploadExcelButton.addEventListener('click', () => {
            const file = excelFile.files[0];
            if (!file) {
                alert('Pilih file Excel terlebih dahulu!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);
                
                const newStudents = json.map(item => ({
                    nisn: String(item.NISN),
                    nis: String(item.NIS),
                    nama_lengkap: item.NAMA_LENGKAP,
                    jenis_kelamin: item.JENIS_KELAMIN,
                    tanggal_lahir: item.TANGGAL_LAHIR,
                    photo: '',
                }));
                
                students = [...students, ...newStudents];
                saveData();
                renderStudentTable();
                renderPrintTable();
                alert('Data siswa berhasil diunggah dari file Excel!');
                excelFile.value = '';
            };
            reader.readAsArrayBuffer(file);
        });

        // --- Admin Dashboard: Upload Photos ---
        uploadPhotosButton.addEventListener('click', () => {
            const files = photoFiles.files;
            if (files.length === 0) {
                alert('Pilih file foto terlebih dahulu!');
                return;
            }
            
            photoUploadStatus.innerHTML = '';
            
            Array.from(files).forEach(file => {
                const nisn = file.name.split('.')[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    const studentIndex = students.findIndex(s => s.nisn === nisn);
                    if (studentIndex !== -1) {
                        students[studentIndex].photo = e.target.result;
                        photoUploadStatus.innerHTML += `<p class="text-green-600">✅ Foto ${file.name} berhasil dicocokkan dengan NISN ${nisn}.</p>`;
                    } else {
                        photoUploadStatus.innerHTML += `<p class="text-red-600">❌ Foto ${file.name} tidak dapat dicocokkan. NISN tidak ditemukan.</p>`;
                    }
                    saveData();
                    renderStudentTable();
                    renderPrintTable();
                };
                reader.readAsDataURL(file);
            });
            alert('Proses unggah foto selesai. Lihat status di bawah.');
            photoFiles.value = '';
        });

        // --- Admin Dashboard: Pengaturan ---
        schoolSettingsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            settings.schoolName = schoolNameInput.value;
            settings.schoolAddress = schoolAddressInput.value;
            settings.schoolPhone = schoolPhoneInput.value;
            settings.principalName = principalNameInput.value;

            const logoFile = schoolLogoInput.files[0];
            const signatureFile = principalSignatureInput.files[0];

            if (logoFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    settings.schoolLogo = e.target.result;
                    if (!signatureFile) {
                        saveData();
                        updateSettings();
                        alert('Pengaturan sekolah berhasil disimpan!');
                    }
                };
                reader.readAsDataURL(logoFile);
            }

            if (signatureFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    settings.principalSignature = e.target.result;
                    saveData();
                    updateSettings();
                    alert('Pengaturan sekolah berhasil disimpan!');
                };
                reader.readAsDataURL(signatureFile);
            }

            if (!logoFile && !signatureFile) {
                saveData();
                updateSettings();
                alert('Pengaturan sekolah berhasil disimpan!');
            }
        });
        
        // --- Admin Dashboard: Pengaturan Kartu ---
        cardDesignForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const cardBackgroundFile = cardBackgroundInput.files[0];
            if (cardBackgroundFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    settings.cardBackground = e.target.result;
                    saveData();
                    alert('Desain kartu berhasil disimpan!');
                };
                reader.readAsDataURL(cardBackgroundFile);
            } else {
                 alert('Pilih file gambar untuk latar belakang kartu terlebih dahulu.');
            }
        });

        // --- Admin Dashboard: Cetak Kartu ---
        function renderPrintTable() {
            printStudentTableBody.innerHTML = '';
            students.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap"><input type="checkbox" class="print-checkbox" data-nisn="${student.nisn}"></td>
                    <td class="px-6 py-4 whitespace-nowrap">${student.nisn}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${student.nama_lengkap}</td>
                `;
                printStudentTableBody.appendChild(row);
            });
        }
        
        selectAllStudents.addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.print-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = e.target.checked);
        });

        async function generateCard(student) {
            const cardElement = document.createElement('div');
            cardElement.className = 'student-card-front bg-white rounded-lg shadow-md w-[320px] h-[200px] p-4 relative overflow-hidden';
            if (settings.cardBackground) {
                 cardElement.style.backgroundImage = `url(${settings.cardBackground})`;
            }

            const qrContainer = document.createElement('div');
            qrContainer.id = `qrcode-print-${student.nisn}`;
            
            cardElement.innerHTML = `
                <div class="flex items-center space-x-2 mb-2">
                    <img src="${settings.schoolLogo || 'https://placehold.co/40x40/e5e7eb/555?text=LOGO'}" alt="Logo" class="w-10 h-10 object-cover rounded-full">
                    <div>
                        <h5 class="text-sm font-bold text-gray-800">${settings.schoolName}</h5>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <div class="w-24 h-32 flex-shrink-0 bg-gray-200 rounded-md overflow-hidden border border-gray-300">
                        <img src="${student.photo || 'https://placehold.co/96x128/e5e7eb/555?text=FOTO'}" alt="Foto Siswa" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-grow text-xs space-y-1">
                        <p><strong>Nama:</strong> ${student.nama_lengkap}</p>
                        <p><strong>NISN:</strong> ${student.nisn}</p>
                        <p><strong>NIS:</strong> ${student.nis}</p>
                        <p><strong>Jenis Kelamin:</strong> ${student.jenis_kelamin}</p>
                        <p><strong>Tgl Lahir:</strong> ${student.tanggal_lahir}</p>
                    </div>
                </div>
                <div class="absolute bottom-4 right-4 text-xs text-center">
                    ${settings.principalSignature ? `<img src="${settings.principalSignature}" alt="Tanda Tangan" class="h-8 object-contain mb-1">` : ''}
                    <p class="font-bold">${settings.principalName}</p>
                    <p>Kepala Sekolah</p>
                </div>
            `;
            
            // Add QR code to the back of the card element
            const qrElement = document.createElement('div');
            qrElement.id = `qr-${student.nisn}`;
            qrElement.className = 'absolute top-4 left-4 p-1 bg-white rounded-lg';
            cardElement.appendChild(qrElement);
            
            // Generate QR code and append to the element
            new QRCode(qrElement, {
                text: `verificationPage?nisn=${student.nisn}`,
                width: 60,
                height: 60,
                correctLevel: QRCode.CorrectLevel.H
            });
            
            return cardElement;
        }

        printSelectedPdfButton.addEventListener('click', async () => {
            const selectedNisns = Array.from(document.querySelectorAll('.print-checkbox:checked')).map(cb => cb.dataset.nisn);
            if (selectedNisns.length === 0) {
                alert('Pilih setidaknya satu siswa untuk dicetak!');
                return;
            }
            
            const doc = new window.jspdf.jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: [90, 56] // Approximate standard card size
            });
            
            for (const nisn of selectedNisns) {
                const student = students.find(s => s.nisn === nisn);
                if (student) {
                    const card = await generateCard(student);
                    document.body.appendChild(card);
                    
                    const canvas = await html2canvas(card, { scale: 2 });
                    const imgData = canvas.toDataURL('image/jpeg');
                    
                    doc.addImage(imgData, 'JPEG', 0, 0, 90, 56);
                    doc.addPage();
                    document.body.removeChild(card);
                }
            }
            
            doc.save('kartu_pelajar.pdf');
        });

        printSelectedImageButton.addEventListener('click', async () => {
            const selectedNisns = Array.from(document.querySelectorAll('.print-checkbox:checked')).map(cb => cb.dataset.nisn);
             if (selectedNisns.length === 0) {
                alert('Pilih setidaknya satu siswa untuk disimpan!');
                return;
            }
            
            for (const nisn of selectedNisns) {
                const student = students.find(s => s.nisn === nisn);
                if (student) {
                    const card = await generateCard(student);
                    document.body.appendChild(card);
                    
                    const canvas = await html2canvas(card, { scale: 2 });
                    const imgData = canvas.toDataURL('image/png');
                    
                    const link = document.createElement('a');
                    link.download = `kartu_pelajar_${student.nisn}.png`;
                    link.href = imgData;
                    link.click();
                    
                    document.body.removeChild(card);
                }
            }
        });

        // --- Student Dashboard ---
        function updateStudentDashboard(user) {
            const student = user.data;
            if (!student) return;

            studentProfileName.textContent = student.nama_lengkap;
            studentProfileNisn.textContent = student.nisn;
            studentProfileNis.textContent = student.nis;
            studentProfileGender.textContent = student.jenis_kelamin;
            studentProfileDob.textContent = student.tanggal_lahir;
            studentProfilePhoto.src = student.photo || 'https://placehold.co/120x150/e5e7eb/555?text=FOTO';

            // Generate card preview
            generateStudentCardPreview(student);
        }

        async function generateStudentCardPreview(student) {
            studentCardPreview.innerHTML = '';
            
            const cardFront = document.getElementById('student-card-front');
            const cardBack = document.getElementById('student-card-back');

            // Card Front Content
            cardFront.innerHTML = `
                <div class="flex items-center space-x-2 mb-2">
                    <img src="${settings.schoolLogo || 'https://placehold.co/40x40/e5e7eb/555?text=LOGO'}" alt="Logo" class="w-10 h-10 object-cover rounded-full">
                    <div>
                        <h5 class="text-sm font-bold text-gray-800">${settings.schoolName}</h5>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <div class="w-24 h-32 flex-shrink-0 bg-gray-200 rounded-md overflow-hidden border border-gray-300">
                        <img src="${student.photo || 'https://placehold.co/96x128/e5e7eb/555?text=FOTO'}" alt="Foto Siswa" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-grow text-xs space-y-1">
                        <p><strong>Nama:</strong> ${student.nama_lengkap}</p>
                        <p><strong>NISN:</strong> ${student.nisn}</p>
                        <p><strong>NIS:</strong> ${student.nis}</p>
                        <p><strong>Jenis Kelamin:</strong> ${student.jenis_kelamin}</p>
                        <p><strong>Tgl Lahir:</strong> ${student.tanggal_lahir}</p>
                    </div>
                </div>
                <div class="absolute bottom-4 right-4 text-xs text-center">
                    ${settings.principalSignature ? `<img src="${settings.principalSignature}" alt="Tanda Tangan" class="h-8 object-contain mb-1">` : ''}
                    <p class="font-bold">${settings.principalName}</p>
                    <p>Kepala Sekolah</p>
                </div>
            `;
            
            if (settings.cardBackground) {
                cardFront.style.backgroundImage = `url(${settings.cardBackground})`;
            }

            // Card Back QR Code
            const qrCodeElement = document.getElementById('qr-code-student');
            qrCodeElement.innerHTML = ''; // Clear previous QR
            new QRCode(qrCodeElement, {
                text: `verificationPage?nisn=${student.nisn}`,
                width: 100,
                height: 100,
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        studentPhotoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const file = document.getElementById('student-new-photo').files[0];
            if (!file) {
                alert('Pilih foto baru terlebih dahulu!');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const studentIndex = students.findIndex(s => s.nisn === loggedInUser.data.nisn);
                if (studentIndex !== -1) {
                    students[studentIndex].photo = e.target.result;
                    loggedInUser.data.photo = e.target.result;
                    saveData();
                    updateStudentDashboard(loggedInUser);
                    alert('Foto profil berhasil diperbarui!');
                }
            };
            reader.readAsDataURL(file);
        });

        showEditProfileModalButton.addEventListener('click', () => {
            const student = loggedInUser.data;
            document.getElementById('student-modal-nama').value = student.nama_lengkap;
            document.getElementById('student-modal-nis').value = student.nis;
            document.getElementById('student-modal-jk').value = student.jenis_kelamin;
            document.getElementById('student-modal-dob').value = student.tanggal_lahir;
            studentEditProfileModal.style.display = 'flex';
        });

        studentEditProfileForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const studentIndex = students.findIndex(s => s.nisn === loggedInUser.data.nisn);
            if (studentIndex !== -1) {
                students[studentIndex].nama_lengkap = document.getElementById('student-modal-nama').value;
                students[studentIndex].nis = document.getElementById('student-modal-nis').value;
                students[studentIndex].jenis_kelamin = document.getElementById('student-modal-jk').value;
                students[studentIndex].tanggal_lahir = document.getElementById('student-modal-dob').value;
                loggedInUser.data = students[studentIndex]; // Update logged-in user data
                saveData();
                updateStudentDashboard(loggedInUser);
                alert('Perbaikan data berhasil diajukan!');
                studentEditProfileModal.style.display = 'none';
            }
        });
        
        downloadCardPngButton.addEventListener('click', async () => {
             const student = loggedInUser.data;
             if (!student) return;
             
             const cardElement = await generateCard(student);
             document.body.appendChild(cardElement);
             
             const canvas = await html2canvas(cardElement, { scale: 2 });
             const imgData = canvas.toDataURL('image/png');
             
             const link = document.createElement('a');
             link.download = `kartu_pelajar_${student.nisn}.png`;
             link.href = imgData;
             link.click();
             
             document.body.removeChild(cardElement);
             alert('Kartu pelajar berhasil diunduh sebagai PNG!');
        });
        
        downloadCardPdfButton.addEventListener('click', async () => {
            const student = loggedInUser.data;
            if (!student) return;
            
            const cardElement = await generateCard(student);
            document.body.appendChild(cardElement);
             
            const doc = new window.jspdf.jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: [90, 56]
            });
            
            const canvas = await html2canvas(cardElement, { scale: 2 });
            const imgData = canvas.toDataURL('image/jpeg');
            
            doc.addImage(imgData, 'JPEG', 0, 0, 90, 56);
            doc.save(`kartu_pelajar_${student.nisn}.pdf`);
            
            document.body.removeChild(cardElement);
            alert('Kartu pelajar berhasil diunduh sebagai PDF!');
        });

        // --- Event Listeners Global ---
        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                const target = e.target.dataset.target;
                switchAdminTab(target);
            });
        });
        
        modalCloseButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                editStudentModal.style.display = 'none';
                studentEditProfileModal.style.display = 'none';
            });
        });

        window.addEventListener('click', (e) => {
            if (e.target === editStudentModal) {
                editStudentModal.style.display = 'none';
            }
            if (e.target === studentEditProfileModal) {
                studentEditProfileModal.style.display = 'none';
            }
        });
        
        // --- QR Verification Page Logic ---
        closeVerificationButton.addEventListener('click', () => {
            history.pushState(null, '', location.pathname); // Remove query string
            showPage(loggedInUser ? (loggedInUser.role === 'admin' ? 'admin' : 'student') : 'login');
        });
        
        // Handle URL parameters for QR code verification
        window.addEventListener('popstate', () => handleUrlChange());
        window.addEventListener('DOMContentLoaded', () => handleUrlChange());
        
        function handleUrlChange() {
            const params = new URLSearchParams(window.location.search);
            const nisn = params.get('nisn');
            if (nisn) {
                const student = students.find(s => s.nisn === nisn);
                if (student) {
                    verName.textContent = student.nama_lengkap;
                    verNisn.textContent = student.nisn;
                    showPage('verification');
                } else {
                    alert('Data siswa tidak ditemukan.');
                    history.pushState(null, '', location.pathname);
                }
            } else if (!loggedInUser) {
                 showPage('login');
            }
        }

        // --- Inisialisasi awal ---
        initializeApp();
    </script>
</body>
</html>
