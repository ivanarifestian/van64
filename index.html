<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAN KARTU - Aplikasi Kartu Pelajar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library untuk membaca file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Library untuk membuat QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Library untuk membuat PDF dari HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Sembunyikan elemen secara default */
        .page { display: none; }
        .active-page { display: block; }
        /* Styling untuk kartu pelajar */
        .student-card {
            width: 520px;
            height: 320px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            background-size: cover;
            background-position: center;
        }
        .card-content {
            position: relative;
            z-index: 2;
            color: #333;
        }
        .card-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 1;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Kontainer utama aplikasi -->
    <div id="app" class="container mx-auto p-4">

        <!-- Halaman Login -->
        <div id="login-page" class="page active-page max-w-md mx-auto mt-10">
            <div class="bg-white p-8 rounded-xl shadow-md">
                <div class="text-center mb-6">
                    <img id="login-logo" src="https://placehold.co/100x100/e2e8f0/e2e8f0?text=Logo" alt="Logo Sekolah" class="mx-auto mb-4 w-24 h-24 rounded-full object-cover">
                    <h1 class="text-2xl font-bold text-gray-800">VAN KARTU</h1>
                    <p class="text-gray-500">Silakan login untuk melanjutkan</p>
                </div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Admin: Van64 / Siswa: NISN" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Password" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200">Login</button>
                </form>
                <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
            </div>
        </div>

        <!-- Dasbor Admin -->
        <div id="admin-dashboard" class="page">
            <!-- Header Admin -->
            <div class="bg-white p-4 rounded-xl shadow-md mb-6 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <img id="admin-header-logo" src="https://placehold.co/50x50/e2e8f0/e2e8f0?text=Logo" alt="Logo Sekolah" class="w-12 h-12 rounded-full object-cover">
                    <div>
                        <h1 id="admin-header-school-name" class="text-xl font-bold text-gray-800">Dasbor Admin</h1>
                        <p class="text-gray-500">Selamat datang, Admin!</p>
                    </div>
                </div>
                <button id="logout-btn" class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition duration-200">Logout</button>
            </div>

            <!-- Navigasi Tab Admin -->
            <div class="mb-6">
                <div class="border-b border-gray-200">
                    <nav id="admin-tabs" class="-mb-px flex space-x-8" aria-label="Tabs">
                        <a href="#data-siswa" class="admin-tab border-indigo-500 text-indigo-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Manajemen Siswa</a>
                        <a href="#upload-data" class="admin-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Upload Data</a>
                        <a href="#pengaturan" class="admin-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Pengaturan</a>
                        <a href="#cetak-kartu" class="admin-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Cetak Kartu</a>
                    </nav>
                </div>
            </div>

            <!-- Konten Tab Admin -->
            <div id="admin-tab-content">
                <!-- Tab Manajemen Siswa -->
                <div id="data-siswa-content" class="admin-tab-pane">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">Data Siswa</h2>
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" id="search-student" placeholder="Cari siswa berdasarkan nama atau NISN..." class="w-1/3 px-3 py-2 border border-gray-300 rounded-md">
                            <button id="add-student-btn" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600">Tambah Siswa Baru</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Foto</th>
                                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Lengkap</th>
                                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIS</th>
                                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Kelamin</th>
                                        <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="student-table-body" class="divide-y divide-gray-200">
                                    <!-- Data siswa akan dimuat di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab Upload Data -->
                <div id="upload-data-content" class="admin-tab-pane hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Upload Data Excel -->
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">Upload Data Siswa (Excel)</h2>
                            <p class="text-gray-600 mb-4">Unggah data siswa secara massal. Pastikan kolom sesuai: NAMA_LENGKAP, NISN, NIS, JENIS_KELAMIN, TANGGAL_LAHIR.</p>
                            <a href="#" id="download-template-btn" class="text-indigo-600 hover:text-indigo-800 font-medium mb-4 inline-block">Unduh Template Excel</a>
                            <input type="file" id="excel-file-input" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 mb-4"/>
                            <button id="upload-excel-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Proses & Simpan Data</button>
                            <div id="upload-excel-status" class="mt-4"></div>
                        </div>
                        <!-- Upload Foto Massal -->
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">Upload Foto Siswa (Massal)</h2>
                            <p class="text-gray-600 mb-4">Unggah foto siswa. Pastikan nama file foto sama dengan <strong>NISN</strong> siswa (contoh: <strong>0012345678.jpg</strong>).</p>
                            <input type="file" id="photo-files-input" multiple accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 mb-4"/>
                            <button id="upload-photos-btn" class="w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600">Upload Foto</button>
                            <div id="upload-photos-status" class="mt-4"></div>
                        </div>
                    </div>
                </div>

                <!-- Tab Pengaturan -->
                <div id="pengaturan-content" class="admin-tab-pane hidden">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800">Pengaturan Aplikasi</h2>
                        <form id="settings-form" class="space-y-6">
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">Profil Sekolah</h3>
                                <div class="mt-4 grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-4">
                                    <div class="sm:col-span-2">
                                        <label for="school-name" class="block text-sm font-medium text-gray-700">Nama Sekolah</label>
                                        <input type="text" id="school-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                    <div class="sm:col-span-2">
                                        <label for="school-address" class="block text-sm font-medium text-gray-700">Alamat Sekolah</label>
                                        <input type="text" id="school-address" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="school-phone" class="block text-sm font-medium text-gray-700">Telepon</label>
                                        <input type="text" id="school-phone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="school-logo" class="block text-sm font-medium text-gray-700">Logo Sekolah</label>
                                        <input type="file" id="school-logo-input" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100">
                                        <img id="logo-preview" class="mt-2 h-20 w-20 object-cover rounded-full" src="https://placehold.co/80x80/e2e8f0/e2e8f0?text=Logo">
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">Detail Kartu Pelajar</h3>
                                <div class="mt-4 grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-4">
                                    <div>
                                        <label for="headmaster-name" class="block text-sm font-medium text-gray-700">Nama Kepala Sekolah</label>
                                        <input type="text" id="headmaster-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="headmaster-signature" class="block text-sm font-medium text-gray-700">Tanda Tangan Kepala Sekolah</label>
                                        <input type="file" id="headmaster-signature-input" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100">
                                        <img id="signature-preview" class="mt-2 h-20 w-auto object-contain bg-gray-100 p-1" src="https://placehold.co/120x80/e2e8f0/e2e8f0?text=TTD">
                                    </div>
                                    <div class="sm:col-span-2">
                                        <label for="card-background" class="block text-sm font-medium text-gray-700">Desain Latar Kartu</label>
                                        <input type="file" id="card-background-input" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100">
                                        <img id="background-preview" class="mt-2 h-28 w-auto object-cover rounded-md border" src="https://placehold.co/260x160/e2e8f0/e2e8f0?text=Background">
                                    </div>
                                </div>
                            </div>
                            <div class="pt-5">
                                <div class="flex justify-end">
                                    <button type="submit" class="bg-indigo-600 text-white py-2 px-6 rounded-md hover:bg-indigo-700">Simpan Pengaturan</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Tab Cetak Kartu -->
                <div id="cetak-kartu-content" class="admin-tab-pane hidden">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">Cetak Kartu Pelajar</h2>
                        <p class="text-gray-600 mb-4">Pilih siswa dari daftar di bawah ini untuk melihat pratinjau dan mencetak kartu mereka.</p>
                         <div class="flex justify-between items-center mb-4">
                             <input type="text" id="search-student-for-print" placeholder="Cari siswa untuk dicetak..." class="w-1/3 px-3 py-2 border border-gray-300 rounded-md">
                             <button id="print-selected-btn" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 disabled:bg-gray-400" disabled>Cetak Kartu Terpilih (PDF)</button>
                         </div>
                        <div id="print-student-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto p-2">
                            <!-- Daftar siswa untuk dicetak -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dasbor Siswa -->
        <div id="student-dashboard" class="page">
             <!-- Header Siswa -->
            <div class="bg-white p-4 rounded-xl shadow-md mb-6 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <img id="student-header-logo" src="https://placehold.co/50x50/e2e8f0/e2e8f0?text=Logo" alt="Logo Sekolah" class="w-12 h-12 rounded-full object-cover">
                    <div>
                        <h1 id="student-header-school-name" class="text-xl font-bold text-gray-800">Profil Siswa</h1>
                        <p id="student-welcome-message" class="text-gray-500">Selamat datang!</p>
                    </div>
                </div>
                <button id="student-logout-btn" class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition duration-200">Logout</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Kolom Kiri: Data & Foto -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md text-center">
                        <img id="student-profile-photo" src="https://placehold.co/150x150/e0e0e0/757575?text=Foto+Siswa" class="w-36 h-36 rounded-full mx-auto mb-4 object-cover border-4 border-white shadow-lg">
                        <h2 id="student-profile-name" class="text-2xl font-bold text-gray-800">Nama Siswa</h2>
                        <p id="student-profile-nisn" class="text-gray-500">NISN: -</p>
                        <label for="change-photo-input" class="mt-4 cursor-pointer inline-block bg-indigo-100 text-indigo-700 py-2 px-4 rounded-md hover:bg-indigo-200 text-sm font-medium">
                            Ganti Foto
                        </label>
                        <input type="file" id="change-photo-input" class="hidden" accept="image/*">
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-bold mb-4 text-gray-800">Ubah Data Pribadi</h3>
                        <form id="student-update-form" class="space-y-4">
                             <div>
                                <label class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                                <input type="text" id="student-form-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700">Tanggal Lahir</label>
                                <input type="date" id="student-form-dob" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                            <button type="submit" class="w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600">Ajukan Perubahan</button>
                        </form>
                    </div>
                </div>

                <!-- Kolom Kanan: Kartu Pelajar -->
                <div class="lg:col-span-2">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-bold mb-4 text-gray-800">Kartu Pelajar Digital Anda</h3>
                        <div id="student-card-preview-container" class="flex justify-center items-center mb-4">
                            <!-- Pratinjau kartu siswa akan dimuat di sini -->
                        </div>
                        <button id="download-card-btn" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">Unduh Kartu (PDF)</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Halaman Verifikasi QR Code -->
        <div id="verification-page" class="page max-w-lg mx-auto mt-10">
            <div class="bg-white p-8 rounded-xl shadow-md text-center">
                <div id="verification-content">
                    <!-- Konten verifikasi akan diisi oleh JS -->
                </div>
            </div>
        </div>

        <!-- Modal untuk Tambah/Edit Siswa -->
        <div id="student-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900 text-center mb-4">Tambah Siswa Baru</h3>
                    <form id="student-form" class="space-y-4">
                        <input type="hidden" id="student-id">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                            <input type="text" id="form-nama" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">NISN</label>
                            <input type="text" id="form-nisn" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">NIS</label>
                            <input type="text" id="form-nis" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Jenis Kelamin</label>
                            <select id="form-gender" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required>
                                <option value="Laki-laki">Laki-laki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Tanggal Lahir</label>
                            <input type="date" id="form-dob" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required>
                        </div>
                        <div class="items-center gap-4 pt-4 flex">
                            <button id="cancel-student-form" type="button" class="w-full justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50">Batal</button>
                            <button id="save-student-form" type="submit" class="w-full justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Template Kartu Pelajar (untuk cloning) -->
        <div id="student-card-template" class="hidden">
            <div class="student-card bg-white font-sans">
                <div class="card-overlay"></div>
                <div class="card-content p-4 flex flex-col h-full">
                    <!-- Header Kartu -->
                    <div class="flex items-center space-x-3 border-b-2 border-gray-500 pb-2">
                        <img class="card-logo h-14 w-14 object-contain" src="" alt="Logo Sekolah">
                        <div class="text-left">
                            <p class="font-bold text-sm uppercase">KARTU PELAJAR</p>
                            <p class="card-school-name font-extrabold text-base uppercase">NAMA SEKOLAH</p>
                            <p class="card-school-address text-xs">Alamat Sekolah</p>
                        </div>
                    </div>
                    <!-- Body Kartu -->
                    <div class="flex-grow flex items-center pt-3">
                        <div class="w-1/3">
                            <img class="card-photo w-24 h-28 object-cover border-2 border-gray-400 rounded-md" src="" alt="Foto Siswa">
                        </div>
                        <div class="w-2/3 pl-3 text-xs">
                            <table class="w-full">
                                <tbody>
                                    <tr><td class="font-semibold pb-1 pr-2">Nama</td><td class="pb-1">: <span class="card-name font-bold"></span></td></tr>
                                    <tr><td class="font-semibold pb-1 pr-2">NIS/NISN</td><td class="pb-1">: <span class="card-nis-nisn"></span></td></tr>
                                    <tr><td class="font-semibold pb-1 pr-2">Tgl Lahir</td><td class="pb-1">: <span class="card-dob"></span></td></tr>
                                    <tr><td class="font-semibold pb-1 pr-2">J. Kelamin</td><td class="pb-1">: <span class="card-gender"></span></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Footer Kartu -->
                    <div class="flex justify-between items-end">
                        <div class="card-qrcode"></div>
                        <div class="text-center">
                            <p class="text-xs">Kepala Sekolah</p>
                            <img class="card-signature h-10 w-24 object-contain mx-auto" src="" alt="Tanda Tangan">
                            <p class="card-headmaster-name font-bold text-xs border-t border-gray-700 mt-1">NAMA KEPALA SEKOLAH</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // ===================================================================================
        // KONFIGURASI FIREBASE
        // Ganti dengan konfigurasi Firebase proyek Anda.
        // Anda bisa mendapatkannya dari Firebase Console:
        // Project Settings > General > Your apps > Web app > Firebase SDK snippet > Config
        // PASTIKAN ANDA MENGGANTI INI, JIKA TIDAK APLIKASI TIDAK AKAN BERFUNGSI!
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "GANTI_DENGAN_API_KEY_ANDA",
            authDomain: "GANTI_DENGAN_AUTH_DOMAIN_ANDA",
            projectId: "GANTI_DENGAN_PROJECT_ID_ANDA",
            storageBucket: "GANTI_DENGAN_STORAGE_BUCKET_ANDA",
            messagingSenderId: "GANTI_DENGAN_MESSAGING_SENDER_ID_ANDA",
            appId: "GANTI_DENGAN_APP_ID_ANDA"
        };

        // ===================================================================================
        // PENTING: ATURAN KEAMANAN (SECURITY RULES) FIREBASE
        // ===================================================================================
        // Untuk aplikasi ini berfungsi, Anda HARUS mengatur Security Rules di Firebase Console.
        //
        // 1. Buka Firebase Console > Firestore Database > Rules
        // Ganti rules yang ada dengan ini:
        /*
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            // Pengaturan sekolah bisa dibaca oleh semua orang, tapi hanya admin yang bisa menulis
            match /settings/{docId} {
              allow read: if true;
              allow write: if request.auth != null && request.auth.token.admin === true;
            }
            
            // Data siswa hanya bisa diakses oleh admin atau siswa yang bersangkutan
            match /students/{userId} {
              allow read, update: if request.auth != null && (request.auth.token.admin === true || request.auth.uid == userId);
              allow create, delete: if request.auth != null && request.auth.token.admin === true;
            }

            // Untuk verifikasi QR Code, izinkan siapa saja membaca data spesifik
            match /students/{userId} {
                 allow get: if true;
            }
          }
        }
        */
        //
        // 2. Buka Firebase Console > Storage > Rules
        // Ganti rules yang ada dengan ini:
        /*
        rules_version = '2';
        service firebase.storage {
          match /b/{bucket}/o {
            // File pengaturan (logo, ttd, dll) bisa dibaca publik
            match /settings/{allPaths=**} {
              allow read: if true;
              allow write: if request.auth != null && request.auth.token.admin === true;
            }
            // Foto siswa hanya bisa diakses oleh admin atau siswa yang bersangkutan
            match /student_photos/{userId}/{allPaths=**} {
              allow read: if true; // Dibuat public read agar mudah ditampilkan di kartu
              allow write: if request.auth != null && (request.auth.token.admin === true || request.auth.uid == userId);
            }
          }
        }
        */
        //
        // 3. Untuk membuat user Admin:
        //    - Buka Firebase Console > Authentication > Users > Add user. Buat user baru.
        //    - Buka Cloud Functions atau gunakan Admin SDK untuk set custom claim 'admin: true'
        //      pada user tersebut. Ini adalah cara yang aman.
        //    - Untuk penyederhanaan di aplikasi ini, kita akan menggunakan login statis.

        // ===================================================================================
        // KODE APLIKASI
        // ===================================================================================
        
        // Impor fungsi yang dibutuhkan dari Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            updateDoc,
            deleteDoc,
            collection,
            getDocs,
            query,
            where,
            enableIndexedDbPersistence // <-- [FIX] Impor fungsi persistensi
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL,
            uploadString
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // [FIX] Aktifkan persistensi offline untuk Firestore
        try {
            await enableIndexedDbPersistence(db);
            console.log("Firestore persistence enabled.");
        } catch (err) {
            if (err.code == 'failed-precondition') {
                console.warn("Firestore persistence failed: Multiple tabs open? Data will not be synced across tabs.");
            } else if (err.code == 'unimplemented') {
                console.warn("Firestore persistence not available in this browser. App will work online only.");
            }
        }

        // State aplikasi
        let allStudents = [];
        let schoolSettings = {};

        // Fungsi utilitas
        const showPage = (pageId) => {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active-page'));
            document.getElementById(pageId).classList.add('active-page');
        };

        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = `fixed top-5 right-5 p-4 rounded-md text-white shadow-lg z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        };

        // Fungsi untuk memuat pengaturan sekolah
        const loadSchoolSettings = async () => {
            try {
                const settingsDoc = await getDoc(doc(db, "settings", "schoolProfile"));
                if (settingsDoc.exists()) {
                    schoolSettings = settingsDoc.data();
                    updateUIWithSettings();
                } else {
                    console.log("Belum ada data pengaturan sekolah. Silakan atur di Dasbor Admin.");
                }
            } catch (error) {
                console.error("Error memuat pengaturan:", error);
                // Jangan tampilkan toast error di sini karena bisa muncul saat offline
            }
        };

        const updateUIWithSettings = () => {
            // Update logo di halaman login
            if (schoolSettings.logoUrl) {
                document.getElementById('login-logo').src = schoolSettings.logoUrl;
                document.getElementById('admin-header-logo').src = schoolSettings.logoUrl;
                document.getElementById('student-header-logo').src = schoolSettings.logoUrl;
            }
            // Update nama sekolah di header admin dan siswa
            if (schoolSettings.schoolName) {
                document.getElementById('admin-header-school-name').textContent = schoolSettings.schoolName;
                document.getElementById('student-header-school-name').textContent = schoolSettings.schoolName;
            }
        };

        // Fungsi untuk membuat kartu pelajar
        const createStudentCard = (studentData, settingsData) => {
            const cardTemplate = document.getElementById('student-card-template').firstElementChild.cloneNode(true);
            
            // Set background
            if (settingsData.backgroundUrl) {
                cardTemplate.style.backgroundImage = `url(${settingsData.backgroundUrl})`;
                cardTemplate.querySelector('.card-overlay').style.display = 'block';
            } else {
                cardTemplate.querySelector('.card-overlay').style.display = 'none';
            }

            // Set data
            cardTemplate.querySelector('.card-logo').src = settingsData.logoUrl || 'https://placehold.co/80x80/e2e8f0/e2e8f0?text=Logo';
            cardTemplate.querySelector('.card-school-name').textContent = settingsData.schoolName || 'NAMA SEKOLAH';
            cardTemplate.querySelector('.card-school-address').textContent = settingsData.schoolAddress || 'Alamat Sekolah';
            cardTemplate.querySelector('.card-photo').src = studentData.photoUrl || 'https://placehold.co/150x150/e0e0e0/757575?text=Foto';
            cardTemplate.querySelector('.card-name').textContent = studentData.namaLengkap;
            cardTemplate.querySelector('.card-nis-nisn').textContent = `${studentData.nis} / ${studentData.nisn}`;
            cardTemplate.querySelector('.card-dob').textContent = studentData.tanggalLahir;
            cardTemplate.querySelector('.card-gender').textContent = studentData.jenisKelamin;
            cardTemplate.querySelector('.card-signature').src = settingsData.signatureUrl || 'https://placehold.co/120x80/e2e8f0/e2e8f0?text=TTD';
            cardTemplate.querySelector('.card-headmaster-name').textContent = settingsData.headmasterName || 'NAMA KEPALA SEKOLAH';

            // Generate QR Code
            const qrCodeContainer = cardTemplate.querySelector('.card-qrcode');
            qrCodeContainer.innerHTML = ''; // Clear previous QR code
            const verificationUrl = `${window.location.origin}${window.location.pathname}?verify=${studentData.nisn}`;
            new QRCode(qrCodeContainer, {
                text: verificationUrl,
                width: 64,
                height: 64,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            return cardTemplate;
        };

        // Fungsi untuk mengunduh kartu sebagai PDF
        const downloadCardAsPDF = async (cardElement, fileName) => {
            const { jsPDF } = window.jspdf;
            const canvas = await html2canvas(cardElement, { scale: 3 });
            const imgData = canvas.toDataURL('image/png');
            
            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'px',
                format: [520, 320]
            });

            pdf.addImage(imgData, 'PNG', 0, 0, 520, 320);
            pdf.save(`${fileName}.pdf`);
        };
        
        const downloadMultipleCardsAsPDF = async (cardElements, fileName) => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'px',
                format: [520, 320]
            });

            for (let i = 0; i < cardElements.length; i++) {
                const canvas = await html2canvas(cardElements[i], { scale: 3 });
                const imgData = canvas.toDataURL('image/png');
                if (i > 0) {
                    pdf.addPage([520, 320], 'landscape');
                }
                pdf.addImage(imgData, 'PNG', 0, 0, 520, 320);
            }
            pdf.save(`${fileName}.pdf`);
        };


        // ===================================================================================
        // LOGIKA LOGIN & AUTHENTIKASI
        // ===================================================================================
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('login-error');
            errorElement.textContent = '';

            // Login Admin (Statis)
            if (username === 'Van64' && password === 'Van1909') {
                console.log("Login Admin berhasil (statis).");
                sessionStorage.setItem('userRole', 'admin');
                // [FIX] Panggil fungsi untuk setup admin dash, onAuthStateChanged tidak akan menangani ini
                await setupAdminDashboard();
                return;
            }

            // Login Siswa (Firebase Auth)
            try {
                const email = `${username}@vankartu.app`; // Domain dummy
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log("Login Siswa berhasil:", user.uid);
                sessionStorage.setItem('userRole', 'student');
                sessionStorage.setItem('userId', user.uid);
                // [FIX] onAuthStateChanged akan otomatis menangani perpindahan halaman
            } catch (error) {
                console.error("Login gagal:", error);
                errorElement.textContent = 'Username atau password salah.';
            }
        });

        const handleLogout = () => {
            signOut(auth).then(() => {
                sessionStorage.clear();
                // [FIX] onAuthStateChanged akan otomatis mengarahkan ke halaman login
                document.getElementById('login-form').reset();
            }).catch((error) => {
                console.error('Logout gagal:', error);
            });
        };

        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        document.getElementById('student-logout-btn').addEventListener('click', handleLogout);

        // [FIX] Titik masuk utama aplikasi. Mengatur halaman berdasarkan status otentikasi.
        onAuthStateChanged(auth, async (user) => {
            // Selalu muat pengaturan sekolah terlebih dahulu, karena semua halaman membutuhkannya
            await loadSchoolSettings();

            const urlParams = new URLSearchParams(window.location.search);
            const isVerification = urlParams.has('verify');
            const userRole = sessionStorage.getItem('userRole');

            if (isVerification) {
                const nisnToVerify = urlParams.get('verify');
                await setupVerificationPage(nisnToVerify);
            } else if (userRole === 'admin') {
                // Jika session admin ada, langsung setup dasbor admin
                await setupAdminDashboard();
            } else if (user && userRole === 'student') {
                // Jika user Firebase ada dan rolenya siswa
                await setupStudentDashboard(user.uid);
            } else {
                // Jika tidak ada kondisi di atas yang terpenuhi, tampilkan halaman login
                showPage('login-page');
            }
        });


        // ===================================================================================
        // LOGIKA DASBOR ADMIN
        // ===================================================================================
        
        const setupAdminDashboard = async () => {
            await loadAllStudents();
            setupSettingsPage();
            showPage('admin-dashboard');
        };

        // Navigasi Tab Admin
        document.getElementById('admin-tabs').addEventListener('click', (e) => {
            e.preventDefault();
            if (e.target.classList.contains('admin-tab')) {
                document.querySelectorAll('.admin-tab').forEach(tab => {
                    tab.classList.remove('border-indigo-500', 'text-indigo-600');
                    tab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                });
                e.target.classList.add('border-indigo-500', 'text-indigo-600');
                e.target.classList.remove('border-transparent', 'text-gray-500');

                document.querySelectorAll('.admin-tab-pane').forEach(pane => pane.classList.add('hidden'));
                const targetPaneId = e.target.getAttribute('href').substring(1) + '-content';
                document.getElementById(targetPaneId).classList.remove('hidden');
            }
        });

        // --- Tab Pengaturan ---
        const settingsForm = document.getElementById('settings-form');
        const logoPreview = document.getElementById('logo-preview');
        const signaturePreview = document.getElementById('signature-preview');
        const backgroundPreview = document.getElementById('background-preview');

        const setupSettingsPage = () => {
            if (schoolSettings) {
                settingsForm['school-name'].value = schoolSettings.schoolName || '';
                settingsForm['school-address'].value = schoolSettings.schoolAddress || '';
                settingsForm['school-phone'].value = schoolSettings.schoolPhone || '';
                settingsForm['headmaster-name'].value = schoolSettings.headmasterName || '';
                logoPreview.src = schoolSettings.logoUrl || 'https://placehold.co/80x80/e2e8f0/e2e8f0?text=Logo';
                signaturePreview.src = schoolSettings.signatureUrl || 'https://placehold.co/120x80/e2e8f0/e2e8f0?text=TTD';
                backgroundPreview.src = schoolSettings.backgroundUrl || 'https://placehold.co/260x160/e2e8f0/e2e8f0?text=Background';
            }
        };

        const handleFileUpload = async (file, path) => {
            if (!file) return null;
            const storageRef = ref(storage, path);
            await uploadBytes(storageRef, file);
            return await getDownloadURL(storageRef);
        };

        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const schoolLogoFile = settingsForm['school-logo-input'].files[0];
            const signatureFile = settingsForm['headmaster-signature-input'].files[0];
            const backgroundFile = settingsForm['card-background-input'].files[0];

            try {
                showToast('Menyimpan pengaturan...', 'success');
                const logoUrl = await handleFileUpload(schoolLogoFile, 'settings/school_logo.jpg');
                const signatureUrl = await handleFileUpload(signatureFile, 'settings/headmaster_signature.png');
                const backgroundUrl = await handleFileUpload(backgroundFile, 'settings/card_background.jpg');

                const updatedSettings = {
                    schoolName: settingsForm['school-name'].value,
                    schoolAddress: settingsForm['school-address'].value,
                    schoolPhone: settingsForm['school-phone'].value,
                    headmasterName: settingsForm['headmaster-name'].value,
                    ...(logoUrl && { logoUrl }),
                    ...(signatureUrl && { signatureUrl }),
                    ...(backgroundUrl && { backgroundUrl }),
                };

                const finalSettings = { ...schoolSettings, ...updatedSettings };

                await setDoc(doc(db, "settings", "schoolProfile"), finalSettings, { merge: true });
                schoolSettings = finalSettings;
                updateUIWithSettings();
                setupSettingsPage();
                showToast('Pengaturan berhasil disimpan!', 'success');
            } catch (error) {
                console.error("Gagal menyimpan pengaturan:", error);
                showToast('Gagal menyimpan pengaturan.', 'error');
            }
        });

        // --- Tab Upload Data ---
        document.getElementById('download-template-btn').addEventListener('click', (e) => {
            e.preventDefault();
            const templateData = [
                ['NAMA_LENGKAP', 'NISN', 'NIS', 'JENIS_KELAMIN', 'TANGGAL_LAHIR']
            ];
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template Data Siswa");
            XLSX.writeFile(wb, "template_siswa_vankartu.xlsx");
        });

        document.getElementById('upload-excel-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('excel-file-input');
            if (fileInput.files.length === 0) {
                showToast('Pilih file Excel terlebih dahulu.', 'error');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            const statusDiv = document.getElementById('upload-excel-status');
            statusDiv.innerHTML = '<p>Membaca file...</p>';

            reader.onload = async (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);

                statusDiv.innerHTML = `<p>Ditemukan ${json.length} data. Memproses...</p>`;
                let successCount = 0;
                let errorCount = 0;

                for (const row of json) {
                    const nisn = String(row.NISN).trim();
                    if (!nisn) {
                        errorCount++;
                        continue;
                    }
                    
                    const studentData = {
                        namaLengkap: row.NAMA_LENGKAP,
                        nisn: nisn,
                        nis: String(row.NIS),
                        jenisKelamin: row.JENIS_KELAMIN,
                        tanggalLahir: row.TANGGAL_LAHIR instanceof Date ? row.TANGGAL_LAHIR.toISOString().split('T')[0] : String(row.TANGGAL_LAHIR)
                    };

                    try {
                        const email = `${nisn}@vankartu.app`;
                        const password = nisn;
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const userId = userCredential.user.uid;
                        await setDoc(doc(db, "students", userId), studentData);
                        successCount++;
                    } catch (error) {
                        if (error.code === 'auth/email-already-in-use') {
                            try {
                                const q = query(collection(db, "students"), where("nisn", "==", nisn));
                                const querySnapshot = await getDocs(q);
                                if (!querySnapshot.empty) {
                                    const existingStudentDoc = querySnapshot.docs[0];
                                    await updateDoc(doc(db, "students", existingStudentDoc.id), studentData);
                                    successCount++;
                                } else { errorCount++; }
                            } catch (updateError) {
                                console.error(`Gagal update data untuk NISN ${nisn}:`, updateError);
                                errorCount++;
                            }
                        } else {
                            console.error(`Gagal proses NISN ${nisn}:`, error);
                            errorCount++;
                        }
                    }
                }
                statusDiv.innerHTML = `<p class="text-green-600">${successCount} data berhasil diimpor.</p><p class="text-red-600">${errorCount} data gagal diimpor.</p>`;
                await loadAllStudents();
            };

            reader.readAsArrayBuffer(file);
        });

        document.getElementById('upload-photos-btn').addEventListener('click', async () => {
            const files = document.getElementById('photo-files-input').files;
            if (files.length === 0) {
                showToast('Pilih file foto terlebih dahulu.', 'error');
                return;
            }

            const statusDiv = document.getElementById('upload-photos-status');
            statusDiv.innerHTML = `<p>Mengunggah ${files.length} foto...</p>`;
            let successCount = 0;
            let errorCount = 0;

            for (const file of files) {
                const nisn = file.name.split('.')[0];
                if (!nisn) {
                    errorCount++;
                    continue;
                }

                try {
                    const q = query(collection(db, "students"), where("nisn", "==", nisn));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        console.warn(`Siswa dengan NISN ${nisn} tidak ditemukan.`);
                        errorCount++;
                        continue;
                    }

                    const studentDoc = querySnapshot.docs[0];
                    const userId = studentDoc.id;
                    
                    const photoRef = ref(storage, `student_photos/${userId}/profile.jpg`);
                    await uploadBytes(photoRef, file);
                    const photoUrl = await getDownloadURL(photoRef);

                    await updateDoc(doc(db, "students", userId), { photoUrl });
                    successCount++;
                } catch (error) {
                    console.error(`Gagal unggah foto untuk NISN ${nisn}:`, error);
                    errorCount++;
                }
            }
            statusDiv.innerHTML = `<p class="text-green-600">${successCount} foto berhasil diunggah.</p><p class="text-red-600">${errorCount} foto gagal diunggah.</p>`;
            await loadAllStudents();
        });

        // --- Tab Manajemen Siswa ---
        const studentTableBody = document.getElementById('student-table-body');
        const studentModal = document.getElementById('student-modal');
        const studentForm = document.getElementById('student-form');

        const loadAllStudents = async () => {
            try {
                const querySnapshot = await getDocs(collection(db, "students"));
                allStudents = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStudentTable(allStudents);
                renderPrintStudentList(allStudents);
            } catch (error) {
                console.error("Error memuat data siswa:", error);
            }
        };

        const renderStudentTable = (students) => {
            studentTableBody.innerHTML = '';
            if (students.length === 0) {
                studentTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Tidak ada data siswa.</td></tr>';
                return;
            }
            students.forEach(student => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-4 px-6"><img src="${student.photoUrl || 'https://placehold.co/40x40/e0e0e0/757575?text=N/A'}" class="w-10 h-10 rounded-full object-cover"></td>
                    <td class="py-4 px-6">${student.namaLengkap}</td>
                    <td class="py-4 px-6">${student.nisn}</td>
                    <td class="py-4 px-6">${student.nis}</td>
                    <td class="py-4 px-6">${student.jenisKelamin}</td>
                    <td class="py-4 px-6">
                        <button class="edit-btn text-indigo-600 hover:text-indigo-900 mr-2" data-id="${student.id}">Edit</button>
                        <button class="delete-btn text-red-600 hover:text-red-900" data-id="${student.id}" data-nisn="${student.nisn}">Hapus</button>
                    </td>
                `;
                studentTableBody.appendChild(tr);
            });
        };
        
        document.getElementById('search-student').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredStudents = allStudents.filter(s => 
                s.namaLengkap.toLowerCase().includes(searchTerm) || 
                s.nisn.includes(searchTerm)
            );
            renderStudentTable(filteredStudents);
        });

        const openStudentModal = (student = null) => {
            studentForm.reset();
            if (student) {
                document.getElementById('modal-title').textContent = 'Edit Data Siswa';
                studentForm['student-id'].value = student.id;
                studentForm['form-nama'].value = student.namaLengkap;
                studentForm['form-nisn'].value = student.nisn;
                studentForm['form-nis'].value = student.nis;
                studentForm['form-gender'].value = student.jenisKelamin;
                studentForm['form-dob'].value = student.tanggalLahir;
                studentForm['form-nisn'].disabled = true;
            } else {
                document.getElementById('modal-title').textContent = 'Tambah Siswa Baru';
                studentForm['student-id'].value = '';
                studentForm['form-nisn'].disabled = false;
            }
            studentModal.classList.remove('hidden');
        };

        document.getElementById('add-student-btn').addEventListener('click', () => openStudentModal());
        document.getElementById('cancel-student-form').addEventListener('click', () => studentModal.classList.add('hidden'));

        studentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = studentForm['student-id'].value;
            const nisn = studentForm['form-nisn'].value;
            const studentData = {
                namaLengkap: studentForm['form-nama'].value,
                nisn: nisn,
                nis: studentForm['form-nis'].value,
                jenisKelamin: studentForm['form-gender'].value,
                tanggalLahir: studentForm['form-dob'].value,
            };

            try {
                if (id) {
                    await updateDoc(doc(db, "students", id), studentData);
                    showToast('Data siswa berhasil diperbarui.', 'success');
                } else {
                    const email = `${nisn}@vankartu.app`;
                    const password = nisn;
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "students", userCredential.user.uid), studentData);
                    showToast('Siswa baru berhasil ditambahkan.', 'success');
                }
                studentModal.classList.add('hidden');
                await loadAllStudents();
            } catch (error) {
                console.error("Gagal menyimpan data siswa:", error);
                showToast(`Gagal menyimpan: ${error.message}`, 'error');
            }
        });

        studentTableBody.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            if (e.target.classList.contains('edit-btn')) {
                const student = allStudents.find(s => s.id === id);
                openStudentModal(student);
            }
            if (e.target.classList.contains('delete-btn')) {
                if (confirm('Apakah Anda yakin ingin menghapus siswa ini? Tindakan ini tidak dapat diurungkan dan akan menghapus akun login siswa.')) {
                    try {
                        await deleteDoc(doc(db, "students", id));
                        showToast('Data siswa berhasil dihapus dari database.', 'success');
                        await loadAllStudents();
                    } catch (error) {
                        console.error("Gagal menghapus siswa:", error);
                        showToast('Gagal menghapus siswa.', 'error');
                    }
                }
            }
        });

        // --- Tab Cetak Kartu ---
        const printStudentListContainer = document.getElementById('print-student-list');
        const printSelectedBtn = document.getElementById('print-selected-btn');

        const renderPrintStudentList = (students) => {
            printStudentListContainer.innerHTML = '';
            if (students.length === 0) {
                printStudentListContainer.innerHTML = '<p class="col-span-full text-center">Tidak ada data siswa.</p>';
                return;
            }
            students.forEach(student => {
                const cardContainer = document.createElement('div');
                cardContainer.className = 'p-2 border rounded-lg cursor-pointer hover:bg-indigo-50 relative';
                cardContainer.dataset.studentId = student.id;

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'print-checkbox absolute top-2 right-2 h-5 w-5';
                checkbox.dataset.studentId = student.id;

                const cardPreview = createStudentCard(student, schoolSettings);
                cardPreview.style.transform = 'scale(0.7)';
                cardPreview.style.transformOrigin = 'top left';
                cardPreview.style.marginBottom = '-80px';
                
                cardContainer.appendChild(checkbox);
                cardContainer.appendChild(cardPreview);
                printStudentListContainer.appendChild(cardContainer);
            });
        };
        
        document.getElementById('search-student-for-print').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredStudents = allStudents.filter(s => 
                s.namaLengkap.toLowerCase().includes(searchTerm) || 
                s.nisn.includes(searchTerm)
            );
            renderPrintStudentList(filteredStudents);
        });
        
        printStudentListContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('print-checkbox')) {
                const selectedCount = document.querySelectorAll('.print-checkbox:checked').length;
                printSelectedBtn.disabled = selectedCount === 0;
                printSelectedBtn.textContent = selectedCount > 0 ? `Cetak ${selectedCount} Kartu Terpilih (PDF)` : 'Cetak Kartu Terpilih (PDF)';
            }
        });

        printSelectedBtn.addEventListener('click', async () => {
            const selectedCheckboxes = document.querySelectorAll('.print-checkbox:checked');
            if (selectedCheckboxes.length === 0) return;

            showToast(`Mempersiapkan ${selectedCheckboxes.length} kartu untuk dicetak...`, 'success');

            const cardsToPrint = [];
            selectedCheckboxes.forEach(checkbox => {
                const studentId = checkbox.dataset.studentId;
                const student = allStudents.find(s => s.id === studentId);
                if (student) {
                    const cardElement = createStudentCard(student, schoolSettings);
                    cardsToPrint.push(cardElement);
                }
            });

            await downloadMultipleCardsAsPDF(cardsToPrint, 'kartu_pelajar_terpilih');
            showToast('PDF berhasil dibuat!', 'success');
        });

        // ===================================================================================
        // LOGIKA DASBOR SISWA
        // ===================================================================================
        const setupStudentDashboard = async (userId) => {
            try {
                const studentDoc = await getDoc(doc(db, "students", userId));
                if (studentDoc.exists()) {
                    const studentData = { id: studentDoc.id, ...studentDoc.data() };
                    
                    document.getElementById('student-welcome-message').textContent = `Selamat datang, ${studentData.namaLengkap.split(' ')[0]}!`;
                    document.getElementById('student-profile-photo').src = studentData.photoUrl || 'https://placehold.co/150x150/e0e0e0/757575?text=Foto+Siswa';
                    document.getElementById('student-profile-name').textContent = studentData.namaLengkap;
                    document.getElementById('student-profile-nisn').textContent = `NISN: ${studentData.nisn}`;

                    document.getElementById('student-form-name').value = studentData.namaLengkap;
                    document.getElementById('student-form-dob').value = studentData.tanggalLahir;

                    const cardPreviewContainer = document.getElementById('student-card-preview-container');
                    const studentCard = createStudentCard(studentData, schoolSettings);
                    cardPreviewContainer.innerHTML = '';
                    cardPreviewContainer.appendChild(studentCard);
                    
                    document.getElementById('download-card-btn').onclick = () => {
                        downloadCardAsPDF(studentCard, `kartu-pelajar-${studentData.nisn}`);
                    };
                    
                    showPage('student-dashboard');

                } else {
                    showToast('Data siswa tidak ditemukan.', 'error');
                    handleLogout();
                }
            } catch (error) {
                console.error("Gagal memuat dasbor siswa:", error);
                showToast('Terjadi kesalahan.', 'error');
            }
        };

        document.getElementById('change-photo-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const userId = sessionStorage.getItem('userId');
            if (!userId) return;

            try {
                showToast('Mengunggah foto...', 'success');
                const photoRef = ref(storage, `student_photos/${userId}/profile.jpg`);
                await uploadBytes(photoRef, file);
                const photoUrl = await getDownloadURL(photoRef);

                await updateDoc(doc(db, "students", userId), { photoUrl });
                
                await setupStudentDashboard(userId);
                showToast('Foto profil berhasil diperbarui!', 'success');
            } catch (error) {
                console.error("Gagal ganti foto:", error);
                showToast('Gagal mengganti foto.', 'error');
            }
        });

        document.getElementById('student-update-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = sessionStorage.getItem('userId');
            if (!userId) return;

            const updatedData = {
                namaLengkap: document.getElementById('student-form-name').value,
                tanggalLahir: document.getElementById('student-form-dob').value,
            };
            
            try {
                await updateDoc(doc(db, "students", userId), updatedData);
                await setupStudentDashboard(userId);
                showToast('Data berhasil diperbarui!', 'success');
            } catch (error) {
                console.error("Gagal update data:", error);
                showToast('Gagal memperbarui data.', 'error');
            }
        });

        // ===================================================================================
        // LOGIKA HALAMAN VERIFIKASI QR
        // ===================================================================================
        const setupVerificationPage = async (nisn) => {
            const contentDiv = document.getElementById('verification-content');
            contentDiv.innerHTML = '<p>Memverifikasi...</p>';
            showPage('verification-page');
            
            try {
                const q = query(collection(db, "students"), where("nisn", "==", nisn));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    contentDiv.innerHTML = `
                        <img src="https://placehold.co/100x100/f87171/ffffff?text=X" class="mx-auto mb-4 w-24 h-24 rounded-full object-cover">
                        <h2 class="text-2xl font-bold text-red-600">Verifikasi Gagal</h2>
                        <p class="text-gray-600 mt-2">Kartu Pelajar tidak valid atau data siswa dengan NISN ${nisn} tidak ditemukan.</p>
                    `;
                    return;
                }

                const studentDoc = querySnapshot.docs[0];
                const studentData = studentDoc.data();

                contentDiv.innerHTML = `
                    <img src="${schoolSettings.logoUrl || 'https://placehold.co/100x100/e2e8f0/e2e8f0?text=Logo'}" class="mx-auto mb-4 w-24 h-24 rounded-full object-cover">
                    <h2 class="text-2xl font-bold text-green-600">Kartu Terverifikasi</h2>
                    <p class="text-gray-500 mb-6">${schoolSettings.schoolName || 'Nama Sekolah'}</p>
                    <div class="text-left space-y-2 bg-gray-50 p-4 rounded-lg">
                        <p><strong>Nama:</strong> ${studentData.namaLengkap}</p>
                        <p><strong>NISN:</strong> ${studentData.nisn}</p>
                        <p><strong>Status:</strong> <span class="font-bold text-green-700 bg-green-100 px-2 py-1 rounded-full">AKTIF</span></p>
                    </div>
                `;

            } catch (error) {
                console.error('Gagal verifikasi:', error);
                contentDiv.innerHTML = `
                    <h2 class="text-2xl font-bold text-red-600">Terjadi Kesalahan</h2>
                    <p class="text-gray-600 mt-2">Tidak dapat terhubung ke server untuk verifikasi.</p>
                `;
            }
        };

    </script>
</body>
</html>
