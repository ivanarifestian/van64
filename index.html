<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VAN KARTU</title>
  <!-- Tailwind CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Libraries: SheetJS (Excel), QRCode, html2pdf -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <style>
    /* simple small custom styles */
    .card-preview { width: 350px; height: 220px; border-radius: 8px; overflow: hidden; }
    .card-bg { background-size: cover; background-position: center; }
    .hidden-page { display: none; }
    .avatar { width: 90px; height: 110px; object-fit: cover; border-radius: 4px; border:2px solid #fff; }
    .table-scroll { max-height: 360px; overflow:auto; }
  </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">
  <div class="min-h-screen flex items-start justify-center p-6">
    <div class="w-full max-w-6xl">
      <header class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
          <img id="schoolLogoSmall" src="" alt="Logo" class="w-14 h-14 object-contain"/>
          <div>
            <h1 class="text-2xl font-bold">VAN KARTU</h1>
            <p id="schoolNameSmall" class="text-sm text-gray-600">SMAN 1 GUNUNGKENCANA</p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-500">SELAMAT DATANG DI VAN KARTU</p>
        </div>
      </header>

      <!-- Pages container -->
      <main class="bg-white p-6 rounded shadow">

        <!-- Login Page -->
        <section id="page-login">
          <div class="max-w-xl mx-auto">
            <h2 class="text-xl font-semibold mb-4">Masuk ke VAN KARTU</h2>
            <form id="formLogin" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Username</label>
                <input id="loginUsername" required class="mt-1 block w-full rounded border-gray-300 shadow-sm" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Password</label>
                <input id="loginPassword" type="password" required class="mt-1 block w-full rounded border-gray-300 shadow-sm" />
              </div>
              <div class="flex items-center justify-between">
                <div class="text-sm text-gray-600">Login Admin: <code>Van64 / Van1909</code></div>
                <button class="px-4 py-2 bg-blue-600 text-white rounded" type="submit">Login</button>
              </div>
            </form>

            <div class="mt-6 text-sm text-gray-500">
              Tip: Untuk Dibuat Oleh: Ivan Arifestian, S.Pd
            </div>
          </div>
        </section>

        <!-- Admin Dashboard -->
        <section id="page-admin" class="hidden-page">
          <div class="flex gap-6">
            <aside class="w-72 bg-gray-50 p-4 rounded">
              <h3 class="font-semibold mb-3">Menu Admin</h3>
              <nav class="flex flex-col gap-2">
                <button class="admin-nav p-2 rounded text-left" data-page="admin-upload-excel">Upload Data Siswa (Excel)</button>
                <button class="admin-nav p-2 rounded text-left" data-page="admin-upload-photos">Upload Foto (Massal)</button>
                <button class="admin-nav p-2 rounded text-left" data-page="admin-manage">Manajemen Data Siswa</button>
                <button class="admin-nav p-2 rounded text-left" data-page="admin-settings">Pengaturan Sekolah</button>
                <button class="admin-nav p-2 rounded text-left" data-page="admin-print">Cetak Kartu</button>
                <button id="btnLogout" class="mt-4 px-3 py-2 bg-red-500 text-white rounded">Logout</button>
              </nav>
            </aside>

            <div class="flex-1">
              <!-- Upload Excel -->
              <div id="admin-upload-excel" class="admin-page">
                <h3 class="font-semibold mb-3">Upload Data Siswa (Excel)</h3>
                <p class="text-sm text-gray-600">Download template, isi lalu upload. Kolom: NAMA_LENGKAP, NISN, NIS, JENIS_KELAMIN, TANGGAL_LAHIR</p>
                <div class="mt-3 flex gap-3 items-center">
                  <a id="downloadTemplate" class="px-3 py-2 bg-gray-200 rounded" href="#">Download Template</a>
                  <input type="file" id="inputExcel" accept=".xlsx,.xls" />
                </div>
              </div>

              <!-- Upload Photos -->
              <div id="admin-upload-photos" class="admin-page hidden-page">
                <h3 class="font-semibold mb-3">Upload Foto Siswa (Massal)</h3>
                <p class="text-sm text-gray-600">Nama file harus <code>NIS.jpg</code> atau <code>NIS.png</code> agar otomatis dipasangkan.</p>
                <input type="file" id="inputPhotos" accept="image/jpeg, image/png" multiple />
                <div id="photoUploadResult" class="mt-3 text-sm text-green-600"></div>
              </div>

              <!-- Manage Students -->
              <div id="admin-manage" class="admin-page hidden-page">
                <div class="flex items-center justify-between">
                  <h3 class="font-semibold">Manajemen Data Siswa</h3>
                  <button id="btnAddStudent" class="px-3 py-1 bg-green-600 text-white rounded">Tambah Siswa</button>
                </div>
                <div class="mt-3">
                  <input id="searchStudent" placeholder="Cari nama / NISN / NIS" class="w-full p-2 rounded border" />
                </div>
                <div class="table-scroll mt-3">
                  <table class="w-full text-sm border-collapse">
                    <thead class="bg-gray-100 sticky top-0">
                      <tr>
                        <th class="p-2 border">#</th>
                        <th class="p-2 border">Foto</th>
                        <th class="p-2 border">Nama</th>
                        <th class="p-2 border">NISN</th>
                        <th class="p-2 border">NIS</th>
                        <th class="p-2 border">TTL</th>
                        <th class="p-2 border">Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="studentsTable"></tbody>
                  </table>
                </div>
              </div>

              <!-- Settings -->
              <div id="admin-settings" class="admin-page hidden-page">
                <h3 class="font-semibold">Pengaturan Sekolah & Desain</h3>
                <div class="grid grid-cols-2 gap-4 mt-3">
                  <div>
                    <label class="block text-sm">Nama Sekolah</label>
                    <input id="inpSchoolName" class="mt-1 p-2 w-full rounded border" />
                  </div>
                  <div>
                    <label class="block text-sm">Alamat</label>
                    <input id="inpSchoolAddress" class="mt-1 p-2 w-full rounded border" />
                  </div>
                  <div>
                    <label class="block text-sm">Telepon</label>
                    <input id="inpSchoolPhone" class="mt-1 p-2 w-full rounded border" />
                  </div>
                  <div>
                    <label class="block text-sm">Logo Sekolah (PNG/JPG)</label>
                    <input id="inpSchoolLogo" type="file" accept="image/*" />
                  </div>
                  <div>
                    <label class="block text-sm">Tanda Tangan Kepala Sekolah</label>
                    <input id="inpSignature" type="file" accept="image/*" />
                    <input id="inpHeadName" class="mt-2 p-2 w-full rounded border" placeholder="Nama Kepala Sekolah" />
                  </div>
                  <div>
                    <label class="block text-sm">Desain Latar Kartu (opsional)</label>
                    <input id="inpCardBg" type="file" accept="image/*" />
                  </div>
                </div>
                <div class="mt-4">
                  <button id="saveSettings" class="px-4 py-2 bg-blue-600 text-white rounded">Simpan Pengaturan</button>
                </div>
              </div>

              <!-- Print / Generate -->
              <div id="admin-print" class="admin-page hidden-page">
                <h3 class="font-semibold mb-3">Cetak Kartu Pelajar</h3>
                <p class="text-sm text-gray-600">Pilih siswa di bawah lalu klik "Generate Kartu".</p>
                <div class="mt-3">
                  <select id="selectStudentsPrint" multiple class="w-full p-2 border rounded h-48"></select>
                </div>
                <div class="mt-3 flex gap-3">
                  <button id="btnGenerateCards" class="px-3 py-2 bg-indigo-600 text-white rounded">Generate Kartu (PDF)</button>
                  <button id="btnPreviewCard" class="px-3 py-2 bg-gray-200 rounded">Preview Satu Kartu</button>
                </div>
                <div class="mt-6">
                  <div id="cardPreviewContainer"></div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- Student Page -->
        <section id="page-student" class="hidden-page">
          <div class="flex gap-6">
            <aside class="w-72 bg-gray-50 p-4 rounded">
              <h3 class="font-semibold mb-3">Menu Siswa</h3>
              <nav class="flex flex-col gap-2">
                <button class="student-nav p-2 rounded text-left" data-page="student-profile">Profil Saya</button>
                <button class="student-nav p-2 rounded text-left" data-page="student-photo">Ubah Foto</button>
                <button class="student-nav p-2 rounded text-left" data-page="student-card">Lihat & Unduh Kartu</button>
                <button id="btnLogout2" class="mt-4 px-3 py-2 bg-red-500 text-white rounded">Logout</button>
              </nav>
            </aside>

            <div class="flex-1">
              <div id="student-profile" class="student-page">
                <h3 class="font-semibold">Profil Saya</h3>
                <div class="mt-3 bg-gray-50 p-4 rounded">
                  <div class="flex gap-4 items-center">
                    <img id="studentAvatar" src="" class="avatar" />
                    <div>
                      <div id="studentFullname" class="text-lg font-semibold">Nama</div>
                      <div class="text-sm text-gray-600">NISN: <span id="studentNISN">-</span></div>
                      <div class="text-sm text-gray-600">NIS: <span id="studentNIS">-</span></div>
                      <div class="text-sm text-gray-600">TTL: <span id="studentTTL">-</span></div>
                    </div>
                  </div>
                  <div class="mt-4">
                    <button id="btnRequestEdit" class="px-3 py-1 bg-yellow-500 text-white rounded">Ajukan Perbaikan Data</button>
                    <button id="btnChangePassword" class="px-3 py-1 bg-gray-200 rounded">Ubah Password</button>
                  </div>
                </div>
              </div>

              <div id="student-photo" class="student-page hidden-page">
                <h3 class="font-semibold">Ubah Foto Profil</h3>
                <p class="text-sm text-gray-600">Unggah foto, sistem akan melakukan crop square otomatis untuk kartu.</p>
                <input id="inpStudentPhoto" type="file" accept="image/*" />
                <div class="mt-3">
                  <canvas id="canvasCrop" class="border"></canvas>
                  <div class="mt-2">
                    <button id="btnSaveCropped" class="px-3 py-1 bg-green-600 text-white rounded">Simpan Foto</button>
                  </div>
                </div>
              </div>

              <div id="student-card" class="student-page hidden-page">
                <h3 class="font-semibold">Kartu Pelajar</h3>
                <div class="mt-3">
                  <div id="studentCardPreview"></div>
                  <div class="mt-3 flex gap-2">
                    <button id="btnDownloadCardImg" class="px-3 py-2 bg-indigo-600 text-white rounded">Download PNG</button>
                    <button id="btnDownloadCardPDF" class="px-3 py-2 bg-gray-200 rounded">Download PDF</button>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- Card template (hidden) -->
  <div id="templateCard" class="hidden">
    <div class="card-preview card-bg p-3 text-white" style="width:350px;height:220px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="display:flex;align-items:center;gap:8px;">
          <img id="tmplLogo" src="" style="height:44px;object-fit:contain;" />
          <div>
            <div id="tmplSchoolName" style="font-weight:700;font-size:14px;color:#fff">Nama Sekolah</div>
            <div style="font-size:12px;color:#fff;opacity:0.9">Kartu Pelajar</div>
          </div>
        </div>
        <div id="tmplQr"></div>
      </div>
      <div style="display:flex;margin-top:12px;gap:12px;">
        <img id="tmplPhoto" src="" style="width:96px;height:100px;object-fit:cover;border:2px solid #fff;" />
        <div style="flex:1;color:#fff">
          <div id="tmplName" style="font-size:16px;font-weight:700"></div>
          <div id="tmplNISN"></div>
          <div id="tmplNIS"></div>
          <div id="tmplGender"></div>
          <div id="tmplTTL"></div>
        </div>
      </div>
      <div style="position:absolute;bottom:12px;right:12px;text-align:center;color:#fff">
        <img id="tmplSignature" src="" style="height:40px;display:block;margin-bottom:4px;" />
        <div id="tmplHeadName" style="font-size:12px"></div>
      </div>
    </div>
  </div>

  <script>
    // ----- Simple localStorage-backed 'DB' -----
    const DB_KEY = 'van_kartu_db_v1';
    const SETTINGS_KEY = 'van_kartu_settings_v1';

    function loadDB() {
      return JSON.parse(localStorage.getItem(DB_KEY) || JSON.stringify({students:[] }));
    }
    function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

    function loadSettings(){ return JSON.parse(localStorage.getItem(SETTINGS_KEY) || JSON.stringify({schoolName:'Sekolah Contoh', address:'-', phone:'-', logo:'', signature:'', headName:'', cardBg:''})); }
    function saveSettings(s){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }

    // init default admin credentials stored in memory (not secure, demo only)
    const ADMIN_CRED = {username:'Van64', password:'Van1909'};

    // ----- UI helpers -----
    function showPage(id){
      document.querySelectorAll('section').forEach(s=>s.classList.add('hidden-page'));
      document.getElementById(id).classList.remove('hidden-page');
    }

    // login handler
    document.getElementById('formLogin').addEventListener('submit', (e)=>{
      e.preventDefault();
      const u = document.getElementById('loginUsername').value.trim();
      const p = document.getElementById('loginPassword').value;
      // admin
      if(u === ADMIN_CRED.username && p === ADMIN_CRED.password){
        startAdmin();
        return;
      }
      // student: username==NISN and password==NISN (initial)
      const db = loadDB();
      const student = db.students.find(s => s.NISN === u);
      if(student){
        if(p === (student.password || student.NISN)){
          startStudent(student.NISN);
          return;
        }
      }
      alert('Login gagal. Periksa username/password.');
    });

    // Logout
    document.getElementById('btnLogout').addEventListener('click', ()=>{ location.reload(); });
    document.getElementById('btnLogout2').addEventListener('click', ()=>{ location.reload(); });

    // Navigation in admin
    document.querySelectorAll('.admin-nav').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.admin-page').forEach(p=>p.classList.add('hidden-page'));
        document.getElementById(btn.dataset.page).classList.remove('hidden-page');
      });
    });

    // Navigation in student
    document.querySelectorAll('.student-nav').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.student-page').forEach(p=>p.classList.add('hidden-page'));
        document.getElementById(btn.dataset.page).classList.remove('hidden-page');
      });
    });

    // download template
    document.getElementById('downloadTemplate').addEventListener('click', (e)=>{
      e.preventDefault();
      const wb = XLSX.utils.book_new();
      const data = [['NAMA_LENGKAP','NISN','NIS','JENIS_KELAMIN','TANGGAL_LAHIR'],['Budi Santoso','0012345678','A001','Laki-Laki','2006-04-12']];
      const ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, 'Template');
      XLSX.writeFile(wb, 'template_van_kartu.xlsx');
    });

    // Excel upload parse
    document.getElementById('inputExcel').addEventListener('change', async (ev)=>{
      const f = ev.target.files[0];
      if(!f) return;
      const data = await f.arrayBuffer();
      const wb = XLSX.read(data);
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
      // expecting header row
      const header = json[0].map(h=>h.toString().toUpperCase());
      const idx = (name)=> header.indexOf(name);
      const db = loadDB();
      for(let r=1;r<json.length;r++){
        const row = json[r];
        if(!row || row.length===0) continue;
        const student = {
          NAMA_LENGKAP: row[idx('NAMA_LENGKAP')] || row[0] || '',
          NISN: (row[idx('NISN')] || '').toString(),
          NIS: (row[idx('NIS')] || '').toString(),
          JENIS_KELAMIN: row[idx('JENIS_KELAMIN')] || '',
          TANGGAL_LAHIR: row[idx('TANGGAL_LAHIR')] || '',
          photo:'', password: ''
        };
        if(!student.NISN) continue;
        // replace or add
        const exist = db.students.findIndex(s=>s.NISN===student.NISN);
        if(exist>=0) db.students[exist] = {...db.students[exist], ...student};
        else db.students.push(student);
      }
      saveDB(db);
      alert('Import selesai. Total siswa: ' + db.students.length);
      refreshStudentsTable();
      populateSelectForPrint();
    });

    // Photo bulk upload
    document.getElementById('inputPhotos').addEventListener('change', async (ev)=>{
      const files = Array.from(ev.target.files);
      const db = loadDB();
      let matched = 0;
      for(const f of files){
        const name = f.name.split('.').slice(0, -1).join('.');
        const targetNISN = name;
        const reader = new FileReader();
        const dataUrl = await new Promise(res=>{reader.onload = ()=>res(reader.result); reader.readAsDataURL(f);});
        const idx = db.students.findIndex(s=>s.NISN === targetNISN);
        if(idx>=0){ db.students[idx].photo = dataUrl; matched++; }
      }
      saveDB(db);
      document.getElementById('photoUploadResult').innerText = `Selesai. Cocokkan: ${matched} foto.`;
      refreshStudentsTable();
    });

    // Manage students table
    function refreshStudentsTable(){
      const db = loadDB();
      const tbody = document.getElementById('studentsTable'); tbody.innerHTML = '';
      const query = document.getElementById('searchStudent').value.toLowerCase();
      db.students.forEach((s, i)=>{
        const text = (s.NAMA_LENGKAP + ' ' + s.NISN + ' ' + s.NIS).toLowerCase();
        if(query && !text.includes(query)) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2 border">${i+1}</td>
          <td class="p-2 border"><img src="${s.photo||''}" class="w-12 h-14 object-cover" /></td>
          <td class="p-2 border">${s.NAMA_LENGKAP||''}</td>
          <td class="p-2 border">${s.NISN||''}</td>
          <td class="p-2 border">${s.NIS||''}</td>
          <td class="p-2 border">${s.TANGGAL_LAHIR||''}</td>
          <td class="p-2 border">
            <button class="btn-edit px-2 py-1 bg-yellow-300 rounded" data-nisn="${s.NISN}">Edit</button>
            <button class="btn-delete px-2 py-1 bg-red-400 text-white rounded" data-nisn="${s.NISN}">Hapus</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      document.querySelectorAll('.btn-delete').forEach(b=>b.addEventListener('click', (e)=>{
        if(!confirm('Hapus siswa ini?')) return;
        const nisn = e.target.dataset.nisn;
        const db = loadDB(); db.students = db.students.filter(s=>s.NISN!==nisn); saveDB(db); refreshStudentsTable(); populateSelectForPrint();
      }));
      document.querySelectorAll('.btn-edit').forEach(b=>b.addEventListener('click', (e)=>{
        const nisn = e.target.dataset.nisn; openEditModal(nisn);
      }));
    }
    document.getElementById('searchStudent').addEventListener('input', refreshStudentsTable);

    // Add student manual
    document.getElementById('btnAddStudent').addEventListener('click', ()=>{
      const name = prompt('Nama lengkap'); if(!name) return;
      const nisn = prompt('NISN'); if(!nisn) return;
      const nis = prompt('NIS (opsional)')||'';
      const gender = prompt('Jenis kelamin (Laki-Laki/Perempuan)')||'';
      const ttl = prompt('Tanggal lahir (YYYY-MM-DD)')||'';
      const db = loadDB();
      if(db.students.find(s=>s.NISN===nisn)){ alert('NISN sudah ada'); return; }
      db.students.push({NAMA_LENGKAP:name, NISN:nisn, NIS:nis, JENIS_KELAMIN:gender, TANGGAL_LAHIR:ttl, photo:'', password:''});
      saveDB(db); refreshStudentsTable(); populateSelectForPrint();
    });

    function openEditModal(nisn){
      const db = loadDB(); const s = db.students.find(x=>x.NISN===nisn);
      if(!s) return alert('Siswa tidak ditemukan');
      const name = prompt('Nama lengkap', s.NAMA_LENGKAP);
      if(name===null) return;
      s.NAMA_LENGKAP = name;
      s.NIS = prompt('NIS', s.NIS)||s.NIS;
      s.JENIS_KELAMIN = prompt('Jenis kelamin', s.JENIS_KELAMIN)||s.JENIS_KELAMIN;
      s.TANGGAL_LAHIR = prompt('Tanggal lahir', s.TANGGAL_LAHIR)||s.TANGGAL_LAHIR;
      saveDB(db); refreshStudentsTable(); populateSelectForPrint();
    }

    // Settings save
    document.getElementById('saveSettings').addEventListener('click', async ()=>{
      const s = loadSettings();
      s.schoolName = document.getElementById('inpSchoolName').value || s.schoolName;
      s.address = document.getElementById('inpSchoolAddress').value || s.address;
      s.phone = document.getElementById('inpSchoolPhone').value || s.phone;
      s.headName = document.getElementById('inpHeadName').value || s.headName;
      // files
      const logoFile = document.getElementById('inpSchoolLogo').files[0];
      if(logoFile){ s.logo = await fileToDataUrl(logoFile); }
      const signFile = document.getElementById('inpSignature').files[0];
      if(signFile){ s.signature = await fileToDataUrl(signFile); }
      const bgFile = document.getElementById('inpCardBg').files[0];
      if(bgFile){ s.cardBg = await fileToDataUrl(bgFile); }
      saveSettings(s);
      applySettingsToUI();
      alert('Pengaturan disimpan');
    });

    function fileToDataUrl(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

    function applySettingsToUI(){
      const s = loadSettings();
      document.getElementById('schoolNameSmall').innerText = s.schoolName || 'Sekolah Anda';
      if(s.logo){ document.getElementById('schoolLogoSmall').src = s.logo; } else document.getElementById('schoolLogoSmall').src='';
    }

    // Admin start
    function startAdmin(){
      showPage('page-admin');
      document.getElementById('admin-upload-excel').classList.remove('hidden-page');
      applySettingsToUI();
      refreshStudentsTable();
      populateSelectForPrint();
    }

    // Populate print select
    function populateSelectForPrint(){
      const s = loadDB().students;
      const sel = document.getElementById('selectStudentsPrint'); sel.innerHTML='';
      s.forEach(st=>{
        const opt = document.createElement('option'); opt.value = st.NISN; opt.text = `${st.NAMA_LENGKAP} â€” ${st.NISN}`; sel.appendChild(opt);
      });
    }

    // Generate cards PDF for selected
    document.getElementById('btnGenerateCards').addEventListener('click', async ()=>{
      const sel = Array.from(document.getElementById('selectStudentsPrint').selectedOptions).map(o=>o.value);
      if(sel.length===0){ alert('Pilih minimal 1 siswa'); return; }
      const db = loadDB(); const settings = loadSettings();
      // create a container
      const container = document.createElement('div');
      for(const nisn of sel){
        const st = db.students.find(x=>x.NISN===nisn); if(!st) continue;
        const card = await renderCardElement(st, settings);
        container.appendChild(card);
        container.appendChild(document.createElement('br'));
      }
      document.body.appendChild(container);
      // use html2pdf
      const opt = { margin:10, filename:'kartu_pelajar.pdf', image:{type:'jpeg', quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm', format:'a4', orientation:'portrait'}};
      await html2pdf().from(container).set(opt).save();
      document.body.removeChild(container);
    });

    // Preview one card
    document.getElementById('btnPreviewCard').addEventListener('click', async ()=>{
      const sel = document.getElementById('selectStudentsPrint'); if(sel.options.length===0) return alert('Tidak ada siswa');
      const nisn = sel.options[0].value; const st = loadDB().students.find(x=>x.NISN===nisn);
      const settings = loadSettings(); const card = await renderCardElement(st, settings);
      const container = document.getElementById('cardPreviewContainer'); container.innerHTML=''; container.appendChild(card);
    });

    async function renderCardElement(student, settings){
      const wrapper = document.createElement('div'); wrapper.style.width='350px'; wrapper.style.height='220px'; wrapper.style.margin='8px'; wrapper.className='card-preview';
      // clone template
      const tpl = document.getElementById('templateCard').firstElementChild.cloneNode(true);
      tpl.style.position='relative';
      // set background
      if(settings.cardBg) tpl.style.backgroundImage = `url(${settings.cardBg})`;
      tpl.querySelector('#tmplLogo').src = settings.logo || '';
      tpl.querySelector('#tmplSchoolName').innerText = settings.schoolName || 'Nama Sekolah';
      tpl.querySelector('#tmplPhoto').src = student.photo || '';
      tpl.querySelector('#tmplName').innerText = student.NAMA_LENGKAP || '';
      tpl.querySelector('#tmplNISN').innerText = 'NISN: ' + (student.NISN||'');
      tpl.querySelector('#tmplNIS').innerText = 'NIS: ' + (student.NIS||'');
      tpl.querySelector('#tmplGender').innerText = 'Jenis Kelamin: ' + (student.JENIS_KELAMIN||'');
      tpl.querySelector('#tmplTTL').innerText = 'TTL: ' + (student.TANGGAL_LAHIR||'');
      tpl.querySelector('#tmplSignature').src = settings.signature || '';
      tpl.querySelector('#tmplHeadName').innerText = settings.headName || '';
      // QR
      const qrd = tpl.querySelector('#tmplQr'); qrd.innerHTML='';
      const verifyUrl = `https://van-kartu.local/verify?nisn=${encodeURIComponent(student.NISN||'')}`; // placeholder
      await QRCode.toCanvas(verifyUrl, {width:80}, (err, canvas)=>{ if(!err) qrd.appendChild(canvas); });

      wrapper.appendChild(tpl);
      return wrapper;
    }

    // Student start
    function startStudent(nisn){
      showPage('page-student');
      const db = loadDB(); const s = db.students.find(x=>x.NISN===nisn);
      if(!s) return alert('Siswa tidak ditemukan');
      window.currentStudent = s.NISN;
      fillStudentProfileUI(s);
    }

    function fillStudentProfileUI(s){
      document.getElementById('studentAvatar').src = s.photo || '';
      document.getElementById('studentFullname').innerText = s.NAMA_LENGKAP || '';
      document.getElementById('studentNISN').innerText = s.NISN || '';
      document.getElementById('studentNIS').innerText = s.NIS || '';
      document.getElementById('studentTTL').innerText = s.TANGGAL_LAHIR || '';
    }

    // request edit
    document.getElementById('btnRequestEdit').addEventListener('click', ()=>{
      const note = prompt('Jelaskan perubahan yang diminta:'); if(!note) return;
      // store request as flag in student record
      const db = loadDB(); const s = db.students.find(x=>x.NISN===window.currentStudent);
      if(s){ s.changeRequest = note; saveDB(db); alert('Permintaan perubahan dikirim, menunggu persetujuan admin.'); }
    });

    // change password (student)
    document.getElementById('btnChangePassword').addEventListener('click', ()=>{
      const p1 = prompt('Password baru:'); if(!p1) return; const p2 = prompt('Ulangi password:'); if(p1!==p2) return alert('Tidak cocok');
      const db = loadDB(); const s = db.students.find(x=>x.NISN===window.currentStudent);
      s.password = p1; saveDB(db); alert('Password berhasil diubah');
    });

    // student photo crop & save
    let imgForCrop = null;
    document.getElementById('inpStudentPhoto').addEventListener('change', async (ev)=>{
      const f = ev.target.files[0]; if(!f) return;
      const data = await fileToDataUrl(f);
      imgForCrop = new Image(); imgForCrop.onload = ()=>{ drawCropPreview(); }; imgForCrop.src = data;
    });
    function drawCropPreview(){
      const c = document.getElementById('canvasCrop'); const ctx = c.getContext('2d');
      // square center-crop
      const size = 320; c.width = size; c.height = size;
      const iw = imgForCrop.width; const ih = imgForCrop.height;
      const scale = Math.max(size/iw, size/ih);
      const sw = size/scale; const sh = size/scale;
      const sx = (iw - sw)/2; const sy = (ih - sh)/2;
      ctx.clearRect(0,0,size,size);
      ctx.drawImage(imgForCrop, sx, sy, sw, sh, 0,0,size,size);
    }
    document.getElementById('btnSaveCropped').addEventListener('click', ()=>{
      const c = document.getElementById('canvasCrop'); const dataUrl = c.toDataURL('image/jpeg', 0.9);
      const db = loadDB(); const s = db.students.find(x=>x.NISN===window.currentStudent);
      s.photo = dataUrl; saveDB(db); fillStudentProfileUI(s); alert('Foto disimpan'); refreshStudentsTable();
    });

    // student card preview and download
    async function buildStudentCardForCurrent(){
      const db = loadDB(), settings = loadSettings(); const s = db.students.find(x=>x.NISN===window.currentStudent);
      const card = await renderCardElement(s, settings);
      const container = document.getElementById('studentCardPreview'); container.innerHTML=''; container.appendChild(card);
      return card;
    }
    document.getElementById('btnDownloadCardImg').addEventListener('click', async ()=>{
      const card = await buildStudentCardForCurrent();
      // convert DOM to canvas via html2canvas (used internally by html2pdf) but easiest: use html2pdf to produce image
      const opt = { margin:0, filename:`kartu_${window.currentStudent}.pdf`, image:{type:'jpeg', quality:0.98}, html2canvas:{scale:2} };
      await html2pdf().from(card).set(opt).toPdf().get('pdf').then(pdf=>{ pdf.save(`kartu_${window.currentStudent}.pdf`); });
    });
    document.getElementById('btnDownloadCardPDF').addEventListener('click', async ()=>{
      const card = await buildStudentCardForCurrent();
      const opt = { margin:10, filename:`kartu_${window.currentStudent}.pdf`, image:{type:'jpeg', quality:0.98}, html2canvas:{scale:2} };
      await html2pdf().from(card).set(opt).save();
    });

    // Setup initial UI values
    (function init(){
      applySettingsToUI();
      // load settings into inputs
      const s = loadSettings();
      document.getElementById('inpSchoolName').value = s.schoolName || '';
      document.getElementById('inpSchoolAddress').value = s.address || '';
      document.getElementById('inpSchoolPhone').value = s.phone || '';
      document.getElementById('inpHeadName').value = s.headName || '';
      refreshStudentsTable(); populateSelectForPrint();
    })();

  </script>
</body>
</html>
